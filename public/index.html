<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="style.css" rel="stylesheet">
        <link href="grayscale.css" rel="stylesheet">
        <link href="interface.css" rel="stylesheet" media="screen">
        <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,800;1,400;1,600;1,800&family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    </head>
    <body>
        
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">Function as useEffect's dependency</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> huytd</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Front End, React</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">1</h1>
            </div>
        </div>
         <p>Khi sá»­ dá»¥ng ESLint trong má»™t dá»± Ã¡n React, kiá»ƒu gÃ¬ báº¡n cÅ©ng sáº½ gáº·p tÃ¬nh huá»‘ng mÃ  báº¡n cho lÃ  vá»› váº©n nhÆ° sau: Báº¡n cÃ³ má»™t Ä‘oáº¡n code xÃ i useEffect, trong Ä‘Ã³ báº¡n gá»i má»™t function, thÆ°á»ng thÃ¬ function nÃ y Ä‘Æ°á»£c táº¡o ra ngay trong component hiá»‡n táº¡i luÃ´n, vÃ­ dá»¥:</p>
<pre><code>const doSomething = (someValue) =&gt; {
    // ...do something with someValue...
}

useEffect(() =&gt; {
   if (someValue) {
      doSomething(someValue)
   }
}, [someValue])
</code></pre>
<p>VÃ  báº¡n sáº½ bá»‹ ESLint quÄƒng ngay má»™t cÃ¢u complain vÃ´ máº·t:</p>
<blockquote>
<p>React Hook useEffect has a missing dependency: â€˜doSomethingâ€™. Either include it or remove the dependency array</p>
</blockquote>
<p>ÄÃ¢y lÃ  warning tá»« plugin <code>eslint-plugin-react-hooks</code>, Ä‘áº¡i Ã½ cá»§a nÃ³ lÃ : â€œÃŠ sao mÃ y xÃ i hÃ m doSomething trong useEffect, mÃ  khÃ´ng cho doSomething vÃ o danh sÃ¡ch dependencies?â€</p>
<p>â€œTÃ o lao háº¿t sá»©c!â€ â€“ báº¡n nghÄ©. NÃ³ lÃ  má»™t cÃ¡i hÃ m chá»© cÃ³ pháº£i value quÃ¡i gÃ¬ Ä‘Ã¢u mÃ  pháº£i bá» vÃ´ dependency list???</p>
<p>Váº­y Ä‘Ã¢y cÃ³ pháº£i lÃ  bug cá»§a <code>eslint-plugin-react-hooks</code> khÃ´ng? ÄÃ¡ng ra chá»‰ nÃªn Ã¡p dá»¥ng rule nÃ y lÃªn cÃ¡c giÃ¡ trá»‹ thÃ´ng thÆ°á»ng thÃ´i, sao cÃ²n Ã¡p dá»¥ng vá»›i cáº£ function?</p>
<p>LÃ½ do lÃ : Function cÅ©ng lÃ  cÃ¡c object, vÃ  trong React (functional component), chÃºng cÅ©ng Ä‘Æ°á»£c khá»Ÿi táº¡o láº¡i sau má»—i láº§n render giá»‘ng nhÆ° má»i object khÃ¡c. Váº­y nÃªn, dÃ¹ function cá»§a báº¡n khÃ´ng Ä‘á»•i, thÃ¬ trÃªn thá»±c táº¿ sau má»—i láº§n render, chÃºng ta Ä‘á»u cÃ³ má»™t instance má»›i cá»§a cÃ¡i function Ä‘Ã³ Ä‘Æ°á»£c táº¡o ra.Äá»ƒ vÃ­ dá»¥ rÃµ hÆ¡n, cÃ³ thá»ƒ xem qua trÆ°á»ng há»£p chÃºng ta dÃ¹ng giÃ¡ trá»‹ cá»§a má»™t state á»Ÿ trong function:</p>
<pre><code>const [name, setName] = useState(&quot;&quot;)

const sayHello = () =&gt; {
   console.log(`Hello, ${name}`)
}

useEffect(() =&gt; {
   sayHello()
}, [name])
</code></pre>
<p>á» vÃ­ dá»¥ trÃªn, vÃ¬ name lÃ  má»™t state value, nÃ³ cÃ³ thá»ƒ thay Ä‘á»•i báº¥t cá»© lÃºc nÃ o vÃ  khiáº¿n cho component bá»‹ re-render. HÃ m sayHello sá»­ dá»¥ng giÃ¡ trá»‹ cá»§a name, nÃªn Ä‘Æ°Æ¡ng nhiÃªn nÃ³ lÃ  má»™t Ä‘á»‘i tÆ°á»£ng cÃ³ kháº£ nÄƒng thay Ä‘á»•i giá»‘ng nhÆ° state. ChÃ­nh vÃ¬ tháº¿ mÃ  cÃ¡c function cÅ©ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o diá»‡n cáº§n Ä‘Æ°a vÃ o dependency list cá»§a useEffect.</p>
<p>Rá»“i, Ä‘Ã£ hiá»ƒu váº¥n Ä‘á», váº­y khi gáº·p tÃ¬nh huá»‘ng nÃ y thÃ¬ lÃ m sao Ä‘á»ƒ fix? CÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, tuá»³ theo implementation cá»§a function cáº§n xá»­ lÃ½.</p>
<p>Náº¿u function khÃ´ng sá»­ dá»¥ng value hay state nÃ o cá»§a component hiá»‡n táº¡i thÃ¬ cÃ³ thá»ƒ move nÃ³ ra khá»i component:</p>
<pre><code>const sayHello = (name: string) =&gt; {
   console.log(&quot;Hello&quot;)
}

const Component = () =&gt; {
   const [name, setName] = useState(&quot;&quot;)

   useEffect(() =&gt; {
      sayHello(name)
   }, [name])
}
</code></pre>
<p>Náº¿u function cÃ³ sá»­ dá»¥ng value hay state thuá»™c component hiá»‡n táº¡i, thÃ¬ cÃ³ thá»ƒ define function nÃ y bÃªn trong khá»‘i useEffect:</p>
<pre><code>const Component = () =&gt; {
   const [name, setName] = useState(&quot;&quot;)
   const [age, setAge] = useState(&quot;&quot;)

   useEffect(() =&gt; {
      const sayHello = () =&gt; {
         console.log(`I am ${name}, I am ${age} yo`)
      }

      sayHello()
   }, [name, age])
}
</code></pre>
<p>LÆ°u Ã½ lÃ , báº¡n pháº£i Ä‘Æ°a luÃ´n toÃ n bá»™ nhá»¯ng state mÃ  function Ä‘Ã³ sá»­ dá»¥ng vÃ o dependency list luÃ´n (vÃ¬ function cá»§a báº¡n phá»¥ thuá»™c vÃ o nhá»¯ng state Ä‘Ã³).</p>
<p>Má»™t cÃ¡ch khÃ¡c lÃ  sá»­ dá»¥ng useCallback hook Ä‘á»ƒ memoize function nÃ y sau má»—i láº§n render, tuá»³ thuá»™c vÃ o giÃ¡ trá»‹ cá»§a cÃ¡c state mÃ  function nÃ y sá»­ dá»¥ng:</p>
<pre><code>const Component = () =&gt; {
   const sayHello = useCallback(() =&gt; {
      ...
   }, [/* danh sÃ¡ch state mÃ  function cáº§n */])

   useEffect(() =&gt; {
      if (age &gt; 0) {
          sayHello()
      }
   }, [age, sayHello])
}
</code></pre>
<p>XÃ i cÃ¡ch nÃ y, báº¡n váº«n pháº£i Ä‘Æ°a function nÃ y vÃ o danh sÃ¡ch dependency nhÆ° cÃ¡ch trÆ°á»›c, nhÆ°ng cÃ³ sá»± phÃ¢n chia trong danh sÃ¡ch dependency rÃµ rÃ ng hÆ¡n.</p>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">You canâ€™t simply send a UDP packet in web browser</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> giongto35</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Front End, Networking</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">2</h1>
            </div>
        </div>
         <p>ThÆ°á»ng trong khi Ä‘i há»c vá» network, chÃºng ta thÆ°á»ng gáº·p cÃ¢u há»i lÃ : trong cÃ¡c trÆ°á»ng há»£p mÃ¬nh Ä‘Ã²i há»i Ä‘á»™ trá»… tháº¥p vÃ  khÃ´ng quan tÃ¢m packet sáº½ bá»‹ rÆ¡i rá»›t giá»¯a chá»«ng, nhÆ° video stream hoáº·c multiplayer game, thÃ¬ network protocol nÃ o nÃªn sá»­ dá»¥ng? CÃ¢u tráº£ lá»i ai cÅ©ng cÃ³ trong Ä‘áº§u lÃ  sá»­ dá»¥ng UDP.</p>
<p>Tuy nhiÃªn, má»™t Ä‘iá»u Ä‘Ã¡ng ngáº¡c nhiÃªn (Ã­t nháº¥t Ä‘á»‘i vá»›i mÃ¬nh) lÃ  khÃ´ng cÃ³ cÃ¡ch thuáº­n tiá»‡n nÃ o Ä‘á»ƒ gá»­i má»™t gÃ³i tin UDP trÃªn WebBrowser. WebSocket chá»‰ há»— trá»£ giao thá»©c TCP.</p>
<p>BÃ i viáº¿t sáº½ tráº£ lá»i táº¡i sao vÃ  chÃºng ta lÃ m tháº¿ nÃ o Ä‘á»ƒ sá»­ dá»¥ng UDP network protocol trÃªn Browser.</p>
<p>&nbsp;</p>
<h2 id="udp-vs-tcp">UDP vs TCP.</h2>
<p>UDP vÃ  TCP lÃ  khÃ¡i niá»‡m cÆ¡ báº£n vÃ  ai cÅ©ng Ä‘Ã£ tá»«ng Ä‘á»c qua nÃªn mÃ¬nh chá»‰ nháº¯c láº¡i nhanh chÃ³ng.</p>
<p>UDP (Unreliable Data Protocol):</p>
<ul>
<li>UDP lÃ  connectionless, nghÄ©a lÃ  mÃ¬nh khÃ´ng táº¡o connection mÃ  gá»­i packet Ä‘i luÃ´n. UDP khÃ´ng cáº§n cÃ¡c cÆ¡ cháº¿ nhÆ° Handshake, Flow Controlâ€¦</li>
</ul>
<p>TCP (Transmission Control Protocol):</p>
<ul>
<li>TCP Ä‘áº£m báº£o data Ä‘Æ°á»£c gá»­i Ä‘i theo Ä‘Ãºng thá»© tá»± vÃ  reliable. TCP cÃ³ cÃ¡c cÆ¡ cháº¿ nhÆ° three-way handshake, flow control, connection termination Ä‘á»ƒ gá»­i packet má»™t cÃ¡ch secure vÃ  duy trÃ¬ smooth connection.</li>
<li>Head-of-line blocking. ÄÃ¢y lÃ  váº¥n Ä‘á» lá»›n nháº¥t cá»§a TCP. Náº¿u má»™t gÃ³i tin bá»‹ tháº¥t láº¡c, cÃ¡c gÃ³i tin tiáº¿p theo sáº½ Ä‘á»£i cho Ä‘áº¿n khi gÃ³i tin bá»‹ máº¥t Ä‘Æ°á»£c gá»­i Ä‘i, áº£nh hÆ°á»Ÿng Ä‘áº¿n throughput vÃ  latency.</li>
</ul>
<h2 id="ná»n-táº£ng-cá»§a-web-browser-Ä‘Æ°á»£c-xÃ¢y-dá»±ng-trÃªn-http">Ná»n táº£ng cá»§a web browser Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn HTTP</h2>
<p>HTTP/HTTPS lÃ  protocol chá»§ yáº¿u Ä‘á»ƒ thá»±c hiá»‡n request vÃ  response giá»¯a browser vÃ  server. HTTP vÃ  HTTPS thÆ°á»ng sá»­ dá»¥ng port 80 vÃ  port 443. VÃ¬ lÃ  ná»n táº£ng máº·c Ä‘á»‹nh, cÃ¡c ports nÃ y thÆ°á»ng Ä‘Æ°á»£c Firewall cho phÃ©p outbound traffic.</p>
<h2 id="websocket-Ä‘Æ°á»£c-xÃ¢y-dá»±ng-trÃªn-httptcp">WebSocket Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn HTTP/TCP.</h2>
<p>WebSocket thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ táº¡o connection 2 chiá»u giá»¯a client vÃ  server vá»›i low latency. WebSocket connection Ä‘Æ°á»£c táº¡o ra báº±ng báº¯t Ä‘áº§u báº±ng HTTP handshake vÃ  sau Ä‘Ã³ Ä‘Æ°á»£c upgrade lÃªn Websocket protocol, táº¡o ra má»™t full-duplex connection. Báº±ng cÃ¡ch dá»±a trÃªn HTTP vÃ  cÃ¡c port máº·c Ä‘á»‹nh cá»§a HTTP, WebSocket khÃ´ng yÃªu cáº§u má»Ÿ thÃªm port cho connection vÃ  dá»… dÃ ng cháº¥p thuáº­n bá»Ÿi Firewall. Tuy nhiÃªn, cÅ©ng vÃ¬ dá»±a trÃªn HTTP, ta cÅ©ng pháº£i sá»­ dá»¥ng TCP cho Websocket.</p>
<h2 id="vÃ¬-sao-udp-khÃ´ng-Ä‘Æ°á»£c-há»—-trá»£-sáºµn-trong-cÃ¡c-trÃ¬nh-duyá»‡t">VÃ¬ sao UDP khÃ´ng Ä‘Æ°á»£c há»— trá»£ sáºµn trong cÃ¡c trÃ¬nh duyá»‡t?</h2>
<p>UDP lÃ  connectionless vÃ  thiáº¿u má»™t sá»‘ tÃ­nh nÄƒng security cÃ³ sáºµn trong HTTPS (TLS). VÃ¬ khÃ´ng cÃ³ connection nÃªn packet nÃ o nhÃ¬n cÅ©ng nhÆ° nhau vÃ  3rd party cÃ³ thá»ƒ chen vÃ o giá»¯a gá»­i packet, táº¡o ra rá»§i ro â€œMan In The Middle Attackâ€. KhÃ´ng cÃ³ SSL nghÄ©a lÃ  gÃ³i tin khÃ´ng Ä‘Æ°á»£c mÃ£ hÃ³a. GÃ³i tin cÃ³ thá»ƒ bá»‹ giáº£ danh hay sá»­a Ä‘á»•i trong quÃ¡ trÃ¬nh gá»­i. UDP cÅ©ng khÃ´ng cÃ³ flow control vÃ  congestion control nhÆ° TCP. Äiá»u nÃ y nghÄ©a lÃ  chÃºng ta khÃ´ng thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c lÆ°u lÆ°á»£ng UDP vÃ  dá»… dáº«n Ä‘áº¿n rá»§i ro DDoS tá»« trÃ¬nh duyá»‡t web. VÃ¬ váº­y, muá»‘n sá»­ dá»¥ng UDP trÃªn WebBrowser, chÃºng ta cáº§n thÃªm cÃ¡c layer phÃ­a trÃªn há»— trá»£ gá»­i UDP má»™t cÃ¡ch an toÃ n.</p>
<h2 id="Ã¢n-nhÃ¢n-webrtc">Ã‚n nhÃ¢n WebRTC</h2>
<p>WebRTC lÃ  má»™t all-in-one protocol tá»•ng há»£p cÃ¡c protocol cho táº§ng transport, network, Video, NAT traverse, vÃ  há»— trá»£ gá»­i UDP packet vá»›i má»¥c Ä‘Ã­ch then chá»‘t Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c real-time p2p communication. Äáº§u tiÃªn, nÃ³ Ä‘Æ°á»£c phÃ¡t triá»ƒn Ä‘á»ƒ cho á»©ng dá»¥ng Video Call nhÆ°ng sau Ä‘Ã³ há»— trá»£ thÃªm Datagram cho phÃ©p gá»­i Ä‘i reliable hoáº·c unreliable packet.</p>
<p>CÃ¡ch tiáº¿p cáº­n nÃ y cho phÃ©p WebRTC cÃ³ thá»ƒ gá»­i vÃ  nháº­n, stream video vá»›i Ä‘á»™ trá»… cá»±c tháº¥p. KhÃ¡c vá»›i cÃ¡c giao thá»©c dá»±a trÃªn HTTP trÃªn cÃ¡c port 80 vÃ  443, WebRTC cho phÃ©p thiáº¿t láº­p peer-to-peer connection giá»¯a báº¥t ká»³ thiáº¿t bá»‹ nÃ o. ThÃ´ng thÆ°á»ng, cÃ¡c káº¿t ná»‘i inbound vÃ  outbound cáº§n Ä‘Æ°á»£c firewall, router thÃ´ng qua, vÃ  khi di chuyá»ƒn giá»¯a cÃ¡c hop trong network, Ä‘á»‹a chá»‰ ip cÅ©ng thay Ä‘á»•i. WebRTC Ä‘áº¡t Ä‘Æ°á»£c quyá»n nÄƒng thÃ´ng qua má»™t cÆ¡ cháº¿ ráº¥t phá»©c táº¡p gá»i lÃ  ICE Ä‘á»ƒ thá»±c hiá»‡n NAT Traverse (vÆ°á»£t tÆ°á»ng lá»­a). CÆ¡ cháº¿ nÃ y giÃºp thiáº¿t bá»‹ tÃ¬m public ip vÃ  public address mÃ  giá»¯a 2 thiáº¿t bá»‹ cÃ³ thá»ƒ láº­p connection Ä‘Æ°á»£c. NÃ³i vá» cÆ¡ cháº¿ nÃ y sáº½ cÃ²n ráº¥t nhiá»u nhÆ°ng ngoÃ i ná»™i dung cá»§a bÃ i viáº¿t.</p>
<p><img src="img/webrtc.png" alt=""></p>
<p>Sau khi connection Ä‘Æ°á»£c thiáº¿t láº­p giá»¯a 2 device, WebRTC sáº½ cho phÃ©p báº¡n stream media hay gá»­i UDP datagram thÃ´ng qua connection nÃ y. WebRTC sá»­ dá»¥ng DTLS (Datagram TLS) nÃªn UDP datagram dá»±a trÃªn WebRTC cÅ©ng Ä‘Æ°á»£c Ä‘áº£m báº£o security.</p>
<h2 id="nhÆ°ng-rá»“i-webrtc-trá»Ÿ-nÃªn-quÃ¡-phá»©c-táº¡p-cho-mÃ´-hÃ¬nh-client-server">NhÆ°ng rá»“i WebRTC trá»Ÿ nÃªn quÃ¡ phá»©c táº¡p cho mÃ´ hÃ¬nh client-server.</h2>
<p>WebRTC ráº¥t rÃ ng buá»™c vá» cÃ¡c protocol Ä‘Æ°á»£c phÃ©p sá»­ dá»¥ng. SCTP, DTLS, RTP, SRTP, ICE vÃ  Video Codec (VP8, H264, OPUS). Má»—i cÃ¡i term nÃ y láº¡i lÃ  má»™t vÃ¹ng trá»i kiáº¿n thá»©c Ä‘Ã²i há»i ngÆ°á»i sá»­ dá»¥ng náº¯m báº¯t. VÃ¬ WebRTC, Ä‘Æ°á»£c thiáº¿t káº¿ ban Ä‘áº§u cho Video Call vÃ  giao tiáº¿p peer-to-peer, cÃ¡c tÃ­nh nÄƒng liÃªn quan Ä‘áº¿n NAT Traversal khÃ´ng cáº§n thiáº¿t trong mÃ´ hÃ¬nh client-server. Vá» phÃ­a server, mÃ¬nh cÃ³ toÃ n quyá»n quyáº¿t Ä‘á»‹nh network vÃ  port setting, khÃ´ng cáº§n WebRTC lÃ m há»™. Khá»Ÿi táº¡o connection cÅ©ng lÃ  má»™t chiá»u outbound tá»« client Ä‘áº¿n server chá»© khÃ´ng pháº£i lÃ  2 chiá»u.</p>
<p>NgoÃ i ra, báº¡n cÅ©ng khÃ´ng cÃ³ nhiá»u kháº£ nÄƒng thay Ä‘á»•i cÃ¡ch báº¡n muá»‘n gá»­i packet náº¿u muá»‘n sá»­a congestion/flow control. WebRTC lÃ  má»™t cÃ¡i blackbox mÃ  náº¿u nÃ³ work thÃ¬ work vÃ  khÃ´ng work thÃ¬ báº¡n cÅ©ng khÃ´ng biáº¿t cÃ¡ch nÃ o khÃ¡c Ä‘á»ƒ lÃ m nÃ³ tá»‘t hÆ¡n.</p>
<p>WebRTC hiá»‡n táº¡i váº«n lÃ  cÃ¡ch phá»• biáº¿n nháº¥t Ä‘á»ƒ gá»­i UDP trong client-server architecture cho cÃ¡c á»©ng dá»¥ng yÃªu cáº§u Ä‘á»™ trá»… tháº¥p nhÆ° Video Stream, Cloud Gaming, Online Game; dÃ¹ cho WebRTC hoÃ n toÃ n báº¯t Ä‘áº§u tá»« má»™t nhu cáº§u khÃ¡c. YÃªu cáº§u gá»­i UDP packet tÆ°á»Ÿng chá»«ng nghe cÆ¡ báº£n vÃ  ná»n táº£ng nÃ y Ä‘ang láº¡i trá»Ÿ thÃ nh má»™t trá»Ÿ ngáº¡i lá»›n khi phÃ¡t triá»ƒn cÃ¡c sáº£n pháº©m Ä‘Ã²i há»i low latency ngÃ y nay.</p>
<h2 id="váº­y-tÆ°Æ¡ng-lai-cá»§a-udp-lÃ ">Váº­y tÆ°Æ¡ng lai cá»§a UDP lÃ ?</h2>
<p>CÃ³ má»™t sá»‘ tiáº¿n triá»ƒn Ä‘Ã¡ng ká»ƒ Ä‘á»ƒ viá»‡c sá»­ dá»¥ng UDP trÃªn WebBrowser ngÃ y cÃ ng kháº£ thi hÆ¡n. ChÃºng ta sáº½ dÃ nh dá»‹p khÃ¡c Ä‘á»ƒ nÃ³i tiáº¿p vá» nÃ³.</p>
<ul>
<li>WebTransport: Há»— trá»£ HTTP/3, giÃºp cÃ³ thá»ƒ thiáº¿t láº­p reliable hoáº·c unreliable transport. (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebTransport">https://developer.mozilla.org/en-US/docs/Web/API/WebTransport</a>)</li>
<li>WHIP/WHEP: WebRTC dá»±a trÃªn HTTP. (<a href="https://www.ietf.org/archive/id/draft-ietf-wish-whip-01.html">https://www.ietf.org/archive/id/draft-ietf-wish-whip-01.html</a>)</li>
</ul>
<h2 id="tham-kháº£o-thÃªm">Tham kháº£o thÃªm</h2>
<ul>
<li>Agar.IO creator phÃ n nÃ n vá» WebSocket khÃ´ng cÃ³ UDP vÃ  WebRTC quÃ¡ phá»©c táº¡p. (<a href="https://news.ycombinator.com/item?id=13264952">https://news.ycombinator.com/item?id=13264952</a>)</li>
</ul>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">Tiny trees, in tiny pots ğŸŒ²</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> Báº§n lÃ m vÆ°á»n</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Hobbies, Plant</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">3</h1>
            </div>
        </div>
         <p>Bonsai. Iâ€™m talking about bonsai. LÃºc báº¯t Ä‘áº§u viáº¿t thÃ¬ mÃ¬nh cÅ©ng hÆ¡i Ä‘áº¯n Ä‘o khÃ´ng biáº¿t lÃ  báº£n thÃ¢n cÃ³ Ä‘á»§ qualified Ä‘á»ƒ viáº¿t vá» chá»§ Ä‘á» nÃ y hay khÃ´ng. NhÆ°ng suy cho cÃ¹ng má»¥c Ä‘Ã­ch cá»§a mÃ¬nh á»Ÿ Ä‘Ã¢y khÃ´ng pháº£i viáº¿t má»™t cÃ¡i comprehensive guide, Ä‘á»ƒ khi Ä‘á»c xong má»i ngÆ°á»i trá»Ÿ thÃ nh bonsai expert. Sharing nÃ y mong cÃ³ thá»ƒ giÃºp cÃ¡c báº¡n hiá»ƒu hÆ¡n vá» bonsai, vÃ  inspire cÃ¡c báº¡n thá»­ sá»©c vá»›i hobby nÃ y.</p>
<h2 id="what-is-bonsai">What is bonsai?</h2>
<p>Bonsai lÃ  má»™t tá»« tiáº¿ng Nháº­t. VÃ  cÅ©ng nhÆ° ráº¥t nhiá»u ká»¹ nghá»‡ khÃ¡c Ä‘Æ°á»£c ngÆ°á»i Nháº­t hoÃ n háº£o hÃ³a vÃ  nÃ¢ng lÃªn táº§m cao má»›i, thÃ¬ concept vá» bonsai vá»‘n cÃ³ xuáº¥t xá»© tá»«â€¦ Trung Hoa cá»• Ä‘áº¡i. Thá»i áº¥y há» ráº¥t xem trá»ng nhá»¯ng váº¥n Ä‘á» vá» phong thá»§y vÃ  cÃ¢n báº±ng ngÅ© hÃ nh (chá»§ Ä‘á» nÃ y thÃ¬ thÃº tháº­t mÃ¬nh mÃ¹). Má»™t cháº­u Bonsai Ä‘Ã³ng vai trÃ² nhÆ° má»™t máº£ng nÃºi, máº£ng rá»«ng thu nhá» trong nhÃ , Ä‘á»ƒ Ä‘áº£m báº£o sá»± cÃ¢n báº±ng ngÅ© hÃ nh Ä‘Ã³ (mÃ¬nh Ä‘oÃ¡n lÃ  mang tÃ­nh kim vÃ  tÃ­nh má»™c or something). Sau hÆ¡n 3000 nÄƒm thÃ¬ ngÆ°á»i ta váº«n thÃ­ch bonsai, khÃ´ng hoÃ n toÃ n vÃ¬ lÃ½ do phong thá»§y ban Ä‘áº§u ná»¯a, mÃ  chá»‰ Ä‘Æ¡n thuáº§n nhÆ° má»™t cÃ¡ch Ä‘á»ƒ há» gáº§n gÅ©i vá»›i thiÃªn nhiÃªn hÆ¡n.Ok. Náº¿u váº­y thÃ¬ bonsai khÃ¡c gÃ¬ nhá»¯ng cÃ¢y trá»“ng cháº­u khÃ¡c? Má»™t quyá»ƒn sÃ¡ch vá» bonsai viáº¿t ráº±ng, bonsai cÃ³ hai tuá»•i. Tuá»•i thá»© nháº¥t lÃ  tuá»•i váº­t lÃ½, sinh lÃ½ cá»§a nÃ³. Tuá»•i thá»© hai lÃ  tuá»•i nÃ³ Ä‘ang mong muá»‘n Ä‘Ã³ng giáº£. Bonsai khÃ´ng pháº£i lÃ  má»™t giá»‘ng cÃ¢y Ä‘áº·c biá»‡t, cÃ³ kÃ­ch cá»¡ nhá» bÃ© ngay cáº£ khi chÃºng giÃ  Ä‘i vÃ  phÃ¡t triá»ƒn tá»‘i Ä‘a. Bonsai lÃ  má»™t cÃ¢y trÆ°á»Ÿng thÃ nh, Ä‘Æ°á»£c cáº©n tháº­n uá»‘n nÃ©n, cáº¯t tá»‰a Ä‘á»ƒ giá»¯ Ä‘Æ°á»£c táº§m vÃ³c thiáº¿u nhi, nhÆ°ng mang dÃ¡ng hÃ¬nh cá»§a má»™t bÃ´ lÃ£o. Sáº½ cÃ³ má»™t sá»‘ style vÃ  loáº¡i cÃ¢y Ä‘Æ°á»£c cho lÃ  phÃ¹ há»£p vá»›i tinh tháº§n bonsai â€œtruyá»n thá»‘ngâ€ hÆ¡n. NhÆ°ng á»Ÿ má»©c Ä‘á»™ cÆ¡ báº£n, báº¥t cá»© loáº¡i cÃ¢y nÃ o cÅ©ng cÃ³ thá»ƒ trá»Ÿ thÃ nh bonsai náº¿u phÃ¹ há»£p vá»›i Ä‘iá»u kiá»‡n trÃªn.
Bonsai is as cheap and interesting as you want it to be</p>
<p>Máº·c dÃ¹ lÃ m vÆ°á»n Ä‘Æ°á»£c má»™t thá»i gian nhÆ°ng mÃ£i Ä‘áº¿n gáº§n Ä‘Ã¢y mÃ¬nh váº«n cÃ²n cÃ³ Ã¡c cáº£m vá»›i bonsai. Bá»Ÿi trong tiá»m thá»©c cá»§a mÃ¬nh, bonsai lÃ  má»™t thÃº chÆ¡i Ä‘áº¯t tiá»n vÃ  mang tÃ­nh phÃ¹ phiáº¿m. Ngá»™ nháº­n nÃ y Ä‘áº¿n tá»« viá»‡c trÆ°á»›c Ä‘Ã¢y khi nghe ngÆ°á»i ta nÃ³i vá» bonsai, Ä‘iá»u mÃ  nhiá»u ngÆ°á»i quan tÃ¢m Ä‘áº¿n Ä‘áº§u tiÃªn lÃ  giÃ¡ trá»‹ váº­t cháº¥t. NhÃ  nÃ o cÃ³ nhiá»u bonsai thÃ¬ nhÃ  áº¥y cháº¯c háº³n lÃ  giÃ u. Nhiá»u ngÆ°á»i sÆ°u táº§m bonsai cÅ©ng chá»‰ xem nÃ³ nhÆ° má»™t mÃ³n hÃ ng hÃ³a xa xá»‰, giÃ¡ trá»‹ cao. Thá»±c táº¿ Ä‘Ã³ lÃ  Ä‘Ãºng. CÃ³ má»™t thá»±c táº¿ khÃ¡c cÅ©ng Ä‘Ãºng lÃ  cÃ³ Ä‘Æ°á»£c má»™t cÃ¢y bonsai Ä‘áº¹p ráº¥t khÃ³, pháº£i tráº£ qua ráº¥t nhiá»u nÄƒm, vÃ  vÃ¬ váº­y giÃ¡ trá»‹ cao cá»§a nÃ³ lÃ  cÃ³ cÄƒn cá»©.Tuy nhiÃªn Ä‘iá»ƒm máº¥u chá»‘t á»Ÿ Ä‘Ã¢y lÃ , bonsai khÃ´ng chá»‰ lÃ  thÃº chÆ¡i sá»Ÿ há»¯u. Vá»›i mÃ¬nh nÃ³ lÃ  má»™t quÃ¡ trÃ¬nh, vÃ  quÃ¡ trÃ¬nh Ä‘Ã³ cÃ³ má»™t cÃ¡i barrier of entry ráº¥t tháº¥p, báº¯t nguá»“n tá»« Ã½ mÃ¬nh Ä‘Ã£ nÃªu á»Ÿ trÃªn: báº¥t cá»© cÃ¢y gÃ¬ cÅ©ng cÃ³ kháº£ nÄƒng trá»Ÿ thÃ nh bonsai. VÃ  khi tá»± mÃ¬nh khÃ´ng Ä‘áº·t náº·ng váº¥n Ä‘á» lÃ m bonsai tháº¿ nÃ o Ä‘á»ƒ há»£p thá»‹ hiáº¿u vÃ  cho Ä‘Æ°á»£c giÃ¡, thÃ¬ khi tham gia cuá»™c chÆ¡i mÃ¬nh sáº½ cÃ³ tinh tháº§n thoáº£i mÃ¡i vÃ  Ä‘Æ°á»£c giáº£i phÃ³ng khá»i nhá»¯ng rÃ ng buá»™c khuÃ´n khá»•. Má»i ngÆ°á»i cÃ³ thá»ƒ search tá»« khÃ³a bonchi (bonsai chili) Ä‘á»ƒ minh chá»©ng cho viá»‡c cÃ¢y nÃ o cÅ©ng cÃ³ thá»ƒ lÃ m bonsai Ä‘Æ°á»£c (yes, ngay cáº£ ğŸ).</p>
<h2 id="how-to-start-making-a-bonsai">How to start making a bonsai?</h2>
<p>Khi lÃ m bonsai ngÆ°á»i ta sáº½ xuáº¥t phÃ¡t tá»« hai hÆ°á»›ng. Má»™t lÃ  há» sáº½ trá»“ng tá»« cÃ¢y con, báº¯t Ä‘áº§u uá»‘n náº¯n nÃ³ ngay tá»« nhá». Hai lÃ  há» sáº½ tÃ¬m má»™t gá»‘c cÃ¢y Ä‘áº¹p, trong tá»± nhiÃªn, hoáº·c lÃ  mua hay xin láº¡i tá»« ai Ä‘Ã³, vÃ  há» sáº½ táº¡o dÃ¡ng láº¡i pháº§n nhÃ¡nh. PhÆ°Æ¡ng Ã¡n má»™t ráº¥t dá»… vÃ  ráº¥t tiáº¿t kiá»‡m Ä‘á»ƒ báº¯t Ä‘áº§u, vÃ  mÃ¬nh cÅ©ng recommend má»i ngÆ°á»i Ä‘i theo hÆ°á»›ng Ä‘Ã³. Táº¥t nhiÃªn lÃ  nÃ³ sáº½ máº¥t nhiá»u thá»i gian hÆ¡n, but hey, itâ€™s part of the journey.:spiral_note_pad: MÃ¬nh gá»­i á»Ÿ Ä‘Ã¢y list má»™t vÃ i loÃ i cÃ¢y thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng lÃ m bonsai vÃ  phÃ¹ há»£p vá»›i khÃ­ háº­u VN:</p>
<p>â€¦</p>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">border-radius thá»±c sá»± lÃ  gÃ¬?</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> ZeroX-DG</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Front End, CSS</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">4</h1>
            </div>
        </div>
         <p>CÃ¡c báº¡n Ä‘á»c tá»±a xong sáº½ nghÄ©: â€œÆ¡ Ã´ng nÃ y vá»› váº©n, border-radius Ä‘á»ƒ bo gÃ³c máº¥y cÃ¡i div chá»© lÃ m gÃ¬?â€</p>
<p>Hmmm nhÆ°ng báº¡n Ä‘Ã£ bao giá» tá»± há»i, cÃ¡i giÃ¡ trá»‹ <code>18px</code> hay <code>50%</code> Ä‘Æ°á»£c pass vÃ o <code>border-radius</code> nghÄ©a lÃ  gÃ¬?</p>
<p>Thá»±c cháº¥t <code>border-radius</code> lÃ  má»™t shorthand property cho 4 CSS properties khÃ¡c. NÃªn khi viáº¿t:</p>
<pre><code class="language-css"><span class="hljs-attribute">border-radius</span>: <span class="hljs-number">18px</span>;
</code></pre>
<p>Báº¡n Ä‘ang viáº¿t táº¯t cho:</p>
<pre><code class="language-css"><span class="hljs-attribute">border-top-left-radius</span>: <span class="hljs-number">18px</span>;
<span class="hljs-attribute">border-top-right-radius</span>: <span class="hljs-number">18px</span>;
<span class="hljs-attribute">border-bottom-left-radius</span>: <span class="hljs-number">18px</span>;
<span class="hljs-attribute">border-bottom-right-radius</span>: <span class="hljs-number">18px</span>;
</code></pre>
<p>4 properties nÃ y Ä‘áº¡i diá»‡n cho 4 gÃ³c cá»§a 1 element box (top left, top right, bottom left vÃ  bottom right), vÃ  browser dÃ¹ng cÃ¡i value báº¡n Ä‘Æ°a vÃ o Ä‘á»ƒ váº½ 1 Ä‘Æ°á»ng con káº¿t ná»‘i 2 cáº¡nh cá»§a gÃ³c cáº§n bo. LÃ m tháº¿ nÃ o Ã¡? CÃ¢u tráº£ lá»i náº±m trong cÃ¡i tÃªn radius.</p>
<p>Radius lÃ  bÃ¡n kÃ­nh hÃ¬nh trÃ²n. Khi váº½ cÃ¡i Ä‘Æ°á»ng cong nÃ y, browser sáº½ dÃ¹ng cÃ¡i bÃ¡n kÃ­nh Ä‘Ã³ Ä‘á»ƒ tÃ­nh ra toáº¡ Ä‘á»™ cá»§a tÃ¢m hÃ¬nh trÃ²n:</p>
<pre><code>x_circle = x_div_corner + border_radius (or -border_radius if it&#x27;s the right edge)
y_circle = y_div_corner + border_radius (or -border_radius if it&#x27;s the bottom edge)
</code></pre>
<p>Sau Ä‘Ã³ váº½ Ä‘Æ°á»ng cong dÃ¹ng cÃ¡i toáº¡ Ä‘á»™ trÃªn, vÃ  thÃªm vÃ i thá»© linh tinh nhÆ° tuá»³ vÃ o gÃ³c lÃ  gÃ³c bÃªn pháº£i hay bÃªn trÃ¡i, trÃªn hay dÆ°á»›i Ä‘á»ƒ váº½ cÃ¡i Ä‘Æ°á»ng cong theo chiá»u Ä‘á»“ng há»“ hoáº·c ngÆ°á»£c etc (xem hÃ¬nh minh hoáº¡).</p>
<p>ÄÃ³ lÃ  lÃ½ do khi <code>border-radius</code> lÃ  <code>50%</code> vÃ  element box cá»§a báº¡n cÃ³ width vÃ  height báº±ng nhau (táº¡o ra hÃ¬nh vuÃ´ng) thÃ¬ browser sáº½ xÃ¡c Ä‘á»‹nh tÃ¢m hÃ¬nh trÃ²n á»Ÿ giá»¯a vá»‹ trÃ­ 50% width vÃ  50% height tá»©c lÃ  á»Ÿ giá»¯a hÃ¬nh vuÃ´ng vÃ  káº» 4 Ä‘Æ°á»ng cong cho 4 gÃ³c táº¡o thÃ nh hÃ¬nh trÃ²n.</p>
<p>Tuy nhiÃªn <code>border-radius</code> khÃ´ng cháº¥p nháº­n giÃ¡ trá»‹ &lt; 0 nÃªn báº¡n khÃ´ng thá»ƒ dÃ¹ng sá»‘ Ã¢m Ä‘á»ƒ bo gÃ³c ngÆ°á»£c vÃ´ trong :laughing:</p>
<p>Tháº¿ nhÆ°ng <code>border-radius</code> thá»±c cháº¥t cÃ³ thá»ƒ cháº¥p nháº­n tá»›i 2 giÃ¡ trá»‹:</p>
<pre><code class="language-css"><span class="hljs-attribute">border-top-left-radius</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
</code></pre>
<p>ÄÃ¢y lÃ  vÃ¬ radius khÃ´ng háº³n lÃ  bÃ¡n kÃ­nh cá»§a hÃ¬nh trÃ²n mÃ  lÃ  hÃ¬nh ellipse nÃªn báº¡n cÃ³ thá»ƒ dÃ¹ng 2 giÃ¡ trá»‹ radius cho chiá»u tháº³ng vÃ  chiá»u ngang khÃ¡c nhau (xem hÃ¬nh minh hoáº¡)</p>
<p><strong>HÃ¬nh minh hoáº¡:</strong></p>
<p><img src="img/image1.png" alt="">
<img src="img/image2.png" alt="">
<img src="img/image3.png" alt=""></p>
<p><strong>Äá»c thÃªm:</strong></p>
<ul>
<li><code>border-radius</code> spec:  <a href="https://drafts.csswg.org/css-backgrounds/#border-radius">https://drafts.csswg.org/css-backgrounds/#border-radius</a></li>
<li><code>border-radius</code> on CSS almanac: <a href="https://css-tricks.com/almanac/properties/b/border-radius/">https://css-tricks.com/almanac/properties/b/border-radius/</a></li>
<li>Forward slash in <code>border-radius</code>: <a href="https://www.sitepoint.com/setting-css3-border-radius-with-slash-syntax/">https://www.sitepoint.com/setting-css3-border-radius-with-slash-syntax/</a></li>
</ul>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">Backup App's local storage for testing on Android</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> tuna</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Mobile, Android</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">5</h1>
            </div>
        </div>
         <h2 id="cÃ¡c-ráº¯c-rá»‘i-vá»›i-local-storage">CÃ¡c ráº¯c rá»‘i vá»›i local storage</h2>
<p>1 app mobile thÆ°á»ng cÃ³ 2 thÃ nh pháº§n lÆ°u trá»¯ chÃ­nh, <strong><em>local storage</em></strong> vÃ  <strong><em>remote storage</em></strong> (server side). Local storage cÃ³ thá»ƒ chá»‰ lÃ  pháº§n pháº£n Ã¡nh dá»¯ liá»‡u á»Ÿ remote, nhÆ°ng cÅ©ng cÃ³ thá»ƒ chá»©a cÃ¡c config chá»‰ dÃ nh cho client.</p>
<p>NgoÃ i ra, dá»¯ liá»‡u á»Ÿ local cÃ²n cÃ³ thá»ƒ chá»©a session cá»§a user tá»« lÃºc Ä‘Äƒng nháº­p. KhÃ¡c vá»›i web app, ngÆ°á»i dÃ¹ng á»Ÿ client thÆ°á»ng chá»‰ Ä‘Äƒng nháº­p 1 láº§n vÃ  sá»­ dá»¥ng. QuÃ¡ trÃ¬nh Ä‘Äƒng nháº­p vá»›i app cÅ©ng phiá»n phá»©c hÆ¡n so vá»›i web app trÃªn PC.</p>
<p>BÃªn cáº¡nh Ä‘Ã³, khi lÃ m viá»‡c vá»›i database, developer thÆ°á»ng gáº·p má»™t Ä‘iá»u phiá»n phá»©c lÃ  version cá»§a database thay Ä‘á»•i, dáº«n Ä‘áº¿n viá»‡c pháº£i clean data trÆ°á»›c rá»“i má»›i cÃ³ thá»ƒ cÃ i Ä‘áº·t (ráº¥t hay gáº·p khi vá»«a pháº£i fix bug trÃªn <code>release</code> branch, vá»«a pháº£i dev feature má»›i trÃªn <code>main</code> branch).
Viá»‡c xoÃ¡ dá»¯ liá»‡u local dáº«n Ä‘áº¿n viá»‡c pháº£i thá»±c hiá»‡n láº¡i háº§u nhÆ° tá»« Ä‘áº§u cÃ¡c thao tÃ¡c Ä‘á»ƒ tÃ¡i thiáº¿t láº­p dá»¯ liá»‡u, hoáº·c tháº­m chÃ­ dá»¯ liá»‡u test tá»« nÄƒm ngoÃ¡i biáº¿n máº¥t khÃ´ng thá»ƒ khÃ´i phá»¥c.</p>
<p>Test migration cÅ©ng lÃ  má»™t viá»‡c phá»©c táº¡p vÃ  cáº§n pháº£i láº·p láº¡i nhiá»u láº§n Ä‘á»ƒ cÃ³ Ä‘á»™ tá»± tin cao. Tuy nhiÃªn, má»™t khi Ä‘Ã£ migrate lÃªn version má»›i, dá»¯ liá»‡u cÅ© khÃ´ng thá»ƒ láº¥y láº¡i Ä‘Æ°á»£c. Muá»‘n cÃ³ dá»¯ liá»‡u cÅ© pháº£i cÃ i láº¡i app version cÅ© vÃ  thá»±c hiá»‡n láº¡i cÃ¡c bÆ°á»›c Ä‘á»ƒ tÃ¡i táº¡o dá»¯ liá»‡u.</p>
<p>Giáº£i phÃ¡p cho nhá»¯ng ráº¯c rá»‘i trÃªn chÃ­nh lÃ  backup local storage Ä‘á»ƒ phá»¥c vá»¥ cho viá»‡c test hoáº·c debug hoáº·c chá»‰ Ä‘á»ƒ tiáº¿t kiá»‡m thá»i gian thiáº¿t láº­p mÃ´i trÆ°á»ng dev cho tuá»³ chá»‰nh khÃ¡c, cÅ©ng giÃºp giáº£m chi phÃ­ cáº§n pháº£i cÃ³ nhiá»u thiáº¿t bá»‹ Ä‘á»ƒ test cho nhiá»u mÃ´i trÆ°á»ng khÃ¡c nhau (vÃ­ dá»¥, 1 device Ä‘á»ƒ test cho account á»Ÿ US, 1 device Ä‘á»ƒ test cho account á»Ÿ VN, etc.).</p>
<h2 id="váº­y-lÃ m-sao-Ä‘á»ƒ-backup-local-storage">Váº­y lÃ m sao Ä‘á»ƒ backup local storage?</h2>
<p>Vá»›i Android, Device Explorer trÃªn Android Studio cÃ³ thá»ƒ giÃºp chÃºng ta lÃ m viá»‡c nÃ y khÃ¡ dá»… dÃ ng, nhÆ°ng láº¡i khÃ¡ máº¥t thá»i gian.
Backup:</p>
<ol>
<li>TÃ¬m app</li>
<li>TÃ¬m folder</li>
<li>Save</li>
<li>Chá»n save location</li>
</ol>
<p>Khi restore, chÃºng ta cáº§n lÃ m láº¡i cÃ¡c bÆ°á»›c tÆ°Æ¡ng tá»±.</p>
<p>CÃ³ cÃ¡ch nÃ o Ä‘á»ƒ lÃ m nhanh hÆ¡n khÃ´ng?
Tháº­t may máº¯n, cÃ¢u tráº£ lá»i lÃ  cÃ³. <code>adb</code> káº¿t há»£p vá»›i <code>dd</code> lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ Ä‘á»ƒ lÃ m Ä‘Æ°á»£c viá»‡c nÃ y. Xem thÃªm chi tiáº¿t chÃ©m giÃ³ <a href="https://iamtuna.org/2023-10-08/use-adb-backup-restore-local-data-2">á»Ÿ Ä‘Ã¢y</a>.</p>
<h3 id="Ã½-tÆ°á»Ÿng-cÆ¡-báº£n">Ã tÆ°á»Ÿng cÆ¡ báº£n:</h3>
<p><strong>Backup</strong></p>
<ol>
<li>NÃ©n cÃ¡c thÆ° má»¥c cáº§n backup vÃ o 1 file <code>.gz</code></li>
<li>Copy file <code>.gz</code> vÃ o <code>sdcard</code> (dÃ¹ tÃªn lÃ  sdcard nhÆ°ng Android sáº½ trá» tá»›i external storage) báº±ng Unix pipe vÃ  <code>dd</code><pre><code class="language-bash">adb shell <span class="hljs-string">&quot;run-as ...&quot;</span> | adb shell <span class="hljs-string">&quot;dd of=/sdcard/...&quot;</span>
</code></pre>
<strong>Restore</strong></li>
<li>Copy file tá»« sdcard vÃ o appâ€™s dir báº±ng dd vÃ  Unix pipe<pre><code class="language-bash">adb shell <span class="hljs-string">&quot;dd if=/sdcard/...&quot;</span> | adb shell <span class="hljs-string">&quot;run-as ...&quot;</span>
</code></pre>
</li>
<li>Giáº£i nÃ©n vÃ  thay cÃ¡c thÆ° má»¥c tÆ°Æ¡ng á»©ng cá»§a app báº±ng ná»™i dung trong backup.</li>
</ol>
<p>Xem script chi tiáº¿t á»Ÿ repo nÃ y: <a href="https://github.com/tuanchauict/android-localstorage-backup/">https://github.com/tuanchauict/android-localstorage-backup/</a> (mirror from my scripts at work, not tested for general debuggable apps).</p>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">Network packet journey in Docker bridge</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> kien (ntk148v)</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Networking, DevOps</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">6</h1>
            </div>
        </div>
         <p>Trong pháº¡m vi cá»§a tÃ i liá»‡u nÃ y, chÃºng ta sáº½ chá»‰ nÃ³i Ä‘áº¿n bridge máº·c Ä‘á»‹nh cá»§a Docker: <code>docker0</code>, khÃ´ng tÃ­nh Ä‘áº¿n cÃ¡c user-defined bridge network. NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn, Docker daemon sá»­ dá»¥ng iptables Ä‘á»ƒ kiá»ƒm soÃ¡t, Ä‘iá»u hÆ°á»›ng káº¿t ná»‘i ra/vÃ o cÃ¡c containers.</p>
<p>Äá»ƒ dá»… hÃ¬nh dung, láº¥y má»™t vÃ­ dá»¥ nhÆ° sau, chÃºng ta cÃ³ má»™t webserver cháº¡y container:</p>
<ul>
<li>Network bridge vÃ  expose port 8000 trÃªn host server.</li>
<li>Host server cÃ³ ip 10.0.10.26, docker0 sub-network 172.17.0.0/16.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/ntk148v/til/master/docker/networking/images/image1.png" alt=""></p>
<h2 id="1-luá»“ng-packet-vá»›i-káº¿t-ná»‘i-tá»«-bÃªn-ngoÃ i-vÃ o-trong-container">1. Luá»“ng packet vá»›i káº¿t ná»‘i tá»« bÃªn ngoÃ i vÃ o trong container</h2>
<p>CÃ¡c chain <code>DOCKER</code>, <code>DOCKER-USER</code> vÃ  <code>DOCKER-ISOLATION-STAGE-*</code> Ä‘á»u do Docker daemon khá»Ÿi táº¡o, cÃ³ thá»ƒ kiá»ƒm tra báº±ng cÃ¡c lá»‡nh sau:</p>
<pre><code class="language-shell">iptables -t nat -S
iptables -S
</code></pre>
<p>Sau Ä‘Ã¢y lÃ  flow di chuyá»ƒn:</p>
<ul>
<li>Gá»­i request tá»« host bÃªn ngoÃ i Ä‘áº¿n endpoint 10.0.10.26:8000</li>
<li>(1) <code>-t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</code><ul>
<li>Packet chuyá»ƒn Ä‘áº¿n chain DOCKER (nat)</li>
</ul>
</li>
<li>(2) -<code>t nat -A DOCKER ! -i docker0 -p tcp -m tcp --dport 8000 -j DNAT --to-destination 172.17.0.2:8000</code><ul>
<li>DNAT, chuyá»ƒn destination ip thÃ nh ip dáº£i bridge 172.17.0.2</li>
</ul>
</li>
<li>(3) <code>-t filter -A FORWARD -j DOCKER-USER</code><ul>
<li>Packet Ä‘áº¿n chain FOWARD (filter), Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n chain DOCKER-USER (filter). Táº¡i Ä‘Ã¢y, packet Ä‘i qua cÃ¡c rules Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng Ä‘á»‹nh nghÄ©a, náº¿u khÃ´ng cÃ³ rule DROP/REJECT nÃ o thÃ¬ sáº½ tráº£ vá» chain FOWARD (filter) (4) Ä‘á»ƒ thá»±c hiá»‡n rule tiáº¿p theo cá»§a chain FORWARD.</li>
</ul>
</li>
<li>(5) <code>-t filter -A FORWARD -j DOCKER-ISOLATION-STAGE-1</code><ul>
<li>TÆ°Æ¡ng tá»± nhÆ° chain DOCKER-USER (filter), khÃ´ng cÃ³ rule nÃ o thÃ¬ tráº£ vá» chain FOWARD (filter) (6). Náº¿u cÃ³ rule match thÃ¬ chuyá»ƒn sang DOCKER-ISOLATION-STAGE-2.</li>
</ul>
</li>
<li>(7) <code>-t filter -A FORWARD -o docker0 -j DOCKER</code><ul>
<li>Packet chuyá»ƒn Ä‘áº¿n chain DOCKER (filter), output docker0. Docker daemon táº¡o cÃ¡c rule dá»±a theo expose ports config cá»§a container, vÃ  tá»± Ä‘á»™ng thÃªm vÃ o chain DOCKER (filter).</li>
</ul>
</li>
<li>(8) <code>-t filter -A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 8000 -j ACCEPT</code><ul>
<li>Táº¡i chain DOCKEr (filter), packet match rule, Ä‘Æ°á»£c accept.</li>
</ul>
</li>
<li>(9) Packet Ä‘i Ä‘áº¿n container Ä‘á»ƒ xá»­ lÃ½.</li>
<li>(10) á» chiá»u ra, packet Ä‘i ra chain OUTPUT -&gt; chain POSTROUTING (nat) Ä‘á»ƒ thá»±c hiá»‡n SNAT.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/ntk148v/til/master/docker/networking/images/image2.png" alt=""></p>
<h2 id="2-luá»“ng-packet-vá»›i-káº¿t-ná»‘i-giá»¯a-cÃ¡c-container-trong-cÃ¹ng-network-bridge">2. Luá»“ng packet vá»›i káº¿t ná»‘i giá»¯a cÃ¡c container trong cÃ¹ng network bridge</h2>
<p>Khá»Ÿi táº¡o thÃªm má»™t container ná»¯a, cÃ¹ng bridge default docker0 vá»›i container webserver hiá»‡n cÃ³. Tá»« container má»›i, thá»±c hiá»‡n gá»­i request Ä‘áº¿n endpoint 10.0.10.26:8000 (dÄ© nhiÃªn trong cÃ¹ng má»™t network, container má»›i cÃ³ thá»ƒ gá»i trá»±c tiáº¿p Ä‘áº¿n 172.17.0.2:8000 cá»§a container webserver, tuy nhiÃªn chÃºng ta khÃ´ng bÃ n tá»›i trÆ°á»ng há»£p Ä‘Ã³). Luá»“ng packet nhÆ° sau:</p>
<ul>
<li>Packet Ä‘i theo default route vá» gateway docker0.</li>
<li>Dá»±a theo rule iptables MASQUERADE, source host vÃ  destination port cá»§a packet thÃ nh 172.17.0.1 vÃ  8000 (do táº¡i vÃ­ dá»¥, chÃºng ta Ä‘á»ƒ exposed port giá»‘ng port trong container, Ä‘á»u lÃ  8000. Trong trÆ°á»ng há»£p port trong container lÃ  80, destination port cá»§a container Ä‘á»•i thÃ nh 80):</li>
</ul>
<pre><code class="language-shell">iptables -t nat -A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
</code></pre>
<ul>
<li>Packet Ä‘i Ä‘áº¿n container webserver.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/ntk148v/til/master/docker/networking/images/image3.png" alt=""></p>
<h2 id="3-luá»“ng-packet-vá»›i-káº¿t-ná»‘i-giá»¯a-container-sá»­-dá»¥ng-network-bridge-khÃ¡c-nhau">3. Luá»“ng packet vá»›i káº¿t ná»‘i giá»¯a container sá»­ dá»¥ng network bridge khÃ¡c nhau</h2>
<p>Äá»‘i vá»›i trÆ°á»ng há»£p giao tiáº¿p giá»¯a cÃ¡c container thuá»™c cÃ¡c dáº£i bridge network khÃ¡c nhau, request Ä‘áº¿n endpoint 10.0.10.26:8000 khi Ä‘áº¿n container webserver sáº½ cÃ³ source 172.17.0.1. ÄÆ°á»ng Ä‘i cá»§a packet nhÆ° sau:</p>
<p><img src="https://raw.githubusercontent.com/ntk148v/til/master/docker/networking/images/image4.png" alt=""></p>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">Xem Ä‘áº¥t 101</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> ledongthuc</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> Hobbies, Real Estate</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">7</h1>
            </div>
        </div>
         <h1 id="xem-Ä‘áº¥t-101">Xem Ä‘áº¥t 101</h1>
<p><del>Má»™t ngÆ°á»i chá»‹ trong nghá» tá»«ng nÃ³i: â€œKhÃ´ng tiá»n thÃ¬ cáº¡p Ä‘áº¥t mÃ  Äƒn.â€</del></p>
<p>Trong suá»‘t nÄƒm vá»«a qua, má»™t ngÆ°á»i <strong>anh em</strong> cá»§a tÃ´i cÃ³ mua Ä‘áº¥t, tÃ´i may máº¯n Ä‘Æ°á»£c Ä‘i theo vÃ i láº§n nÃªn cÃ³ má»™t vÃ i kinh nghiá»‡m nhá» nhoi. Trong quÃ¡ trÃ¬nh nÃ y, tÃ´i Ä‘Ã£ ghi chÃ©p láº¡i má»™t sá»‘ Ä‘iá»ƒm quan trá»ng cáº§n chÃº Ã½ khi xem xÃ©t vÃ  cÃ³ káº¿ hoáº¡ch mua Ä‘áº¥t.</p>
<p><strong>Disclaimer</strong>: LÆ°u Ã½ ráº±ng thÃ´ng tin dÆ°á»›i Ä‘Ã¢y mang tÃ­nh cháº¥t chá»§ quan vÃ  Ä‘á»“ng Ã½ ráº±ng nÃªn kiá»ƒm tra thÃ´ng tin trá»±c tiáº¿p.</p>
<h2 id="1-loáº¡i-Ä‘áº¥t">1. Loáº¡i Ä‘áº¥t</h2>
<h3 id="11-Ä‘áº¥t-dá»±-Ã¡n">1.1. Äáº¥t Dá»± Ãn</h3>
<p>Äáº¥t dá»± Ã¡n, hay cÃ²n Ä‘Æ°á»£c biáº¿t Ä‘áº¿n nhÆ° Ä‘áº¥t ná»n dá»± Ã¡n, lÃ  nhá»¯ng lÃ´ Ä‘áº¥t thuá»™c quy hoáº¡ch cá»§a chá»§ Ä‘áº§u tÆ°, chÆ°a cÃ³ xÃ¢y dá»±ng, thÆ°á»ng Ä‘Æ°á»£c phÃ¢n lÃ´ vÃ  bÃ¡n láº¡i sau khi háº¡ táº§ng Ä‘Æ°á»£c xÃ¢y dá»±ng.</p>
<p>Loáº¡i Ä‘áº¥t nÃ y thÆ°á»ng Ä‘Æ°á»£c chÃ­nh quyá»n duyá»‡t vÃ  cÃ³ quy hoáº¡ch chi tiáº¿t, bao gá»“m máº­t Ä‘á»™ xÃ¢y dá»±ng, cÃ¢y xanh, chiá»u cao xÃ¢y dá»±ng, vÃ  háº¡ táº§ng giao thÃ´ng rÃµ rÃ ng.</p>
<p>ÄÃ¢y cÅ©ng lÃ  loáº¡i Ä‘áº¥t thÆ°á»ng Ä‘Æ°á»£c cÃ¡c báº¡n sale cháº¡y nhiá»u nháº¥t. VÃ  cÅ©ng lÃ  loáº¡i Ä‘áº¥t trong thá»i gian gáº§n Ä‘Ã¢y nhiá»u chá»§ Ä‘áº§u tÆ° khÃ´ng uy tÃ­n bÃ¡n nháº¥t, vÃ¬ Ä‘á»ƒ cÃ³ thá»ƒ bÃ¡n Ä‘Æ°á»£c, chá»§ Ä‘áº§u tÆ° pháº£i Ä‘áº£m báº£o:</p>
<ul>
<li>XÃ¢y dá»±ng káº¿t cáº¥u háº¡ táº§ng cÃ´ng trÃ¬nh káº¿t cáº¥u háº¡ táº§ng theo quy hoáº¡ch chi tiáº¿t xÃ¢y dá»±ng 1/500 Ä‘Æ°á»£c cáº¥p cÃ³ tháº©m quyá»n phÃª duyá»‡t.</li>
<li>Äáº£m báº£o cung cáº¥p cÃ¡c dá»‹ch vá»¥ thiáº¿t yáº¿u lÃ  cáº¥p Ä‘iá»‡n, cáº¥p nÆ°á»›c, thoÃ¡t nÆ°á»›c, thu gom rÃ¡c tháº£i.</li>
<li>Chá»§ Ä‘áº§u tÆ° hoÃ n thÃ nh nghÄ©a vá»¥ tÃ i chÃ­nh liÃªn quan Ä‘áº¿n Ä‘áº¥t Ä‘ai ( tiá»n sá»­ dá»¥ng Ä‘áº¥t, thuáº¿, lá»‡ phÃ­, Ä‘á»n bÃ¹).</li>
<li>Giáº¥y chá»©ng nháº­n hoáº·c quyáº¿t Ä‘á»‹nh giao Ä‘áº¥t/quyáº¿t Ä‘á»‹nh cho thuÃª Ä‘áº¥t.</li>
<li>Giáº¥y tá» xÃ¡c minh hoÃ n thÃ nh nghÄ©a vá»¥ tÃ i chÃ­nh cá»§a chá»§ Ä‘áº§u tÆ° Ä‘á»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘áº¥t há»£p phÃ¡p.</li>
<li>Giáº¥y phÃ©p xÃ¢y dá»±ng.
NhÆ°ng thÃ´ng thÆ°á»ng, cÃ¡c chá»§ Ä‘áº§u tÆ° sáº½ cá»‘ gáº¯ng bÃ¡n lÃ´ Ä‘áº¥t trÆ°á»›c Ä‘á»ƒ cÃ³ vá»‘n xÃ¢y dá»±ng, nÃªn sáº£y ra trÆ°á»ng há»£p Ä‘áº¥t Ä‘Ã£ mua rá»“i nhÆ°ng háº¡ tÃ ng chÆ°a xong vÃ  cÅ©ng khÃ´ng thá»ƒ ra giáº¥y tá» Ä‘Æ°á»£c. Trong vÃ i nÄƒm trá»Ÿ láº¡i Ä‘Ã¢y, há» kÃªu gá»i gÃ³p vá»‘n dÆ°á»›i hÃ¬nh thá»©c há»£p Ä‘á»“ng gÃ³p vá»‘n. ÄÃ¢y lÃ  dáº¡ng há»£p Ä‘á»“ng há»£p tÃ¡c kinh doanh báº¥t Ä‘á»™ng sáº£n dÆ°á»›i hÃ¬nh thá»©c gÃ³p vá»‘n Ä‘áº§u tÆ° Ä‘á»ƒ cÃ³ thá»ƒ lÃ¡ch luáº­t khÃ´ng thá»ƒ bÃ¡n Ä‘áº¥t nhÆ°ng váº«n cÃ³ thá»ƒ cÃ³ vá»‘n.</li>
</ul>
<h3 id="12-Ä‘áº¥t-thá»•-cÆ°">1.2. Äáº¥t thá»• cÆ°</h3>
<p>KhÃ¡c vá»›i Ä‘áº¥t dá»± Ã¡n, Ä‘áº¥t thá»• cÆ° lÃ  Ä‘áº¥t mÃ  ngÆ°á»i dÃ¢n quáº£n lÃ½ trá»±c tiáº¿p mÃ  khÃ´ng thÃ´ng qua chá»§ Ä‘áº§u tÆ°. ÄÃ¢y bao gá»“m Ä‘áº¥t á»Ÿ á»Ÿ khu vá»±c nÃ´ng thÃ´n vÃ  Ä‘Ã´ thá»‹.</p>
<p>CÃ³ hai loáº¡i Ä‘áº¥t thá»• cÆ° chÃ­nh: Ä‘áº¥t thá»• cÆ° Ä‘Ã´ thá»‹ vÃ  Ä‘áº¥t thá»• cÆ° nÃ´ng thÃ´n, Ä‘Æ°á»£c áº£nh hÆ°á»Ÿng bá»Ÿi chÃ­nh sÃ¡ch quáº£n lÃ½ vÃ  quy hoáº¡ch Ä‘á»‹a phÆ°Æ¡ng.</p>
<p>Äáº¥t thá»• cÆ° Ä‘Ã´ thá»‹ thuá»™c phÆ°á»ng, thá»‹ tráº¥n, quáº­n, thÃ nh phá»‘, thá»‹ xÃ£ hoáº·c khu quy hoáº·c Ä‘Ã´ thá»‹ má»›i. Trong khi Ä‘Ã³ Ä‘áº¥t thá»• cÆ° nÃ´ng thÃ´n thuá»™c khu vá»±c nÃ´ng thÃ´n vÃ  do xÃ£ quáº£n lÃ½.</p>
<p>Hai loáº¡i Ä‘áº¥t thá»• cÆ° nÃ y sáº½ áº£nh hÆ°á»Ÿng nhiá»u tá»« chÃ­nh sÃ¡ch quáº£n lÃ½, Ä‘Æ°á»£c Ã¡p dá»¥ng chÃ­nh sÃ¡ch thu thuáº¿ cÅ©ng nhÆ° quy hoáº¡ch riÃªng. Vd á»Ÿ má»™t vÃ i Ä‘á»‹a phÆ°Æ¡ng cÃ³ Ä‘áº¥t thá»• cÆ° nÃ´ng thÃ´n mÃ¬nh biáº¿t cÃ³ thá»ƒ xÃ¢y dá»±ng khÃ´ng cáº§n xin giáº¥y phÃ©p náº¿u khÃ´ng cÃ³ quy hoáº¡ch. Vá»‹ trÃ­ Ä‘áº¥t cÅ©ng áº£nh hÆ°á»Ÿng nhiá»u tá»›i quy Ä‘á»‹nh vá» diá»‡n tÃ­ch tá»‘i thiá»ƒu Ä‘á»ƒ tÃ¡ch thá»­a, tÃ¡ch sá»•.</p>
<h3 id="13-Ä‘áº¥t-nÃ´ng-nghiá»‡p">1.3. Äáº¥t nÃ´ng nghiá»‡p</h3>
<p>Äáº¥t nÃ´ng nghiá»‡p lÃ  loáº¡i Ä‘áº¥t Ä‘Æ°á»£c sá»­ dá»¥ng chá»§ yáº¿u cho má»¥c Ä‘Ã­ch trá»“ng cÃ¢y trá»“ng, hoa mÃ u, Ä‘áº¥t rá»«ng, trá»“ng cÃ¢y lÃ¢u nÄƒm, trá»“ng cÃ¢y hÃ ng nÄƒm, trá»“ng lÃºa, rá»«ng, nuÃ´i trá»“ng thuá»· sáº£n, chÄƒn nuÃ´i gia sÃºc.</p>
<p>Äáº¥t nÃ´ng nghiá»‡p thÆ°á»ng Ä‘Æ°á»£c mua náº¿u báº¡n cÃ³ dá»± Ä‘á»‹nh lÃ m nÃ´ng, hoáº·c chá» quy hoáº¡ch Ä‘á»ƒ chuyá»ƒn Ä‘á»•i má»¥c Ä‘Ã­ch sá»­ dá»¥ng lÃªn Ä‘áº¥t thá»• cÆ°.</p>
<h2 id="2-phÃ¡p-lÃ½">2. PhÃ¡p lÃ½</h2>
<h3 id="21-giáº¥y-chá»©ng-nháº­n-quyá»n-sá»­-dá»¥ng-Ä‘áº¥t-quyá»n-sá»Ÿ-há»¯u-nhÃ -á»Ÿ-vÃ -tÃ i-sáº£n-khÃ¡c-gáº¯n-liá»n-vá»›i-Ä‘áº¥t">2.1. Giáº¥y chá»©ng nháº­n quyá»n sá»­ dá»¥ng Ä‘áº¥t, quyá»n sá»Ÿ há»¯u nhÃ  á»Ÿ vÃ  tÃ i sáº£n khÃ¡c gáº¯n liá»n vá»›i Ä‘áº¥t</h3>
<p>Hay cÃ²n Ä‘Æ°á»£c gá»i lÃ  sá»• há»“ng, thÆ°á»ng lÃ  giáº¥y tá» phÃ¡p lÃ½ Ä‘áº§u tiÃªn nÃªn kiá»ƒm tra khi xem Ä‘áº¥t. TrÃªn sá»• sáº½ cÃ³ thÃ´ng tin vá»:</p>
<ul>
<li>Loáº¡i Ä‘áº¥t</li>
<li>Thá»i háº¡n sá»­ dá»¥ng Ä‘áº¥t</li>
<li>ThÃ´ng tin vá» cÃ¡c pháº§n Ä‘Æ°á»£c vÃ  khÃ´ng Ä‘Æ°á»£c cÃ´ng nháº­n tá»« phÃ­a cÃ³ tháº©m quyá»n</li>
<li>KÃ­ch thÆ°á»›c vÃ  hÃ¬nh dáº¡ng Ä‘áº¥t</li>
<li>Toáº¡ Ä‘á»™ vá»‹ trÃ­ Ä‘áº¥t</li>
</ul>
<h3 id="22-quy-hoáº¡ch-Ä‘áº¥t-vÃ -tranh-cháº¥p">2.2. Quy hoáº¡ch Ä‘áº¥t vÃ  tranh cháº¥p</h3>
<p>NgoÃ i viá»‡c xem trÃªn sá»• há»“ng/sá»• Ä‘á», thÃ´ng tin quy hoáº¡ch vÃ  tranh cháº¥p cÃ³ thá»ƒ láº¥y thÃ´ng tin má»›i nháº¥t tá»« Uá»· Ban NhÃ¢n DÃ¢n cáº¥p xÃ£, phÆ°á»ng, thá»‹ tráº¥n, phÃ²ng Ä‘á»‹a chÃ­nh Ä‘á»ƒ xin thÃ´ng tin quy hoáº¡ch cá»§a miáº¿ng Ä‘áº¥t. Hoáº·c cÃ¡ch mÃ¬nh hay sá»­ dá»¥ng hÆ¡n lÃ  gá»­i phiáº¿u yÃªu cáº§u thÃ´ng tin quy hoáº¡ch Ä‘áº¥t táº¡i vÄƒn phÃ²ng Ä‘Äƒng kÃ½ Ä‘áº¥t Ä‘ai táº¡i Ä‘á»‹a phÆ°Æ¡ng áº¥y.</p>
<p>Báº±ng viá»‡c thu tháº­p thÃ´ng tin quy hoáº¡ch Ä‘áº¥t, ta sáº½ cÃ³ thÃªm thÃ´ng tin vá»:</p>
<ul>
<li>Diá»‡n tÃ­ch vÃ  hÃ¬nh dáº¡ng pháº§n Ä‘áº¥t thá»• cÆ°, vÃ  phi thá»• cÆ°.</li>
<li>Nhá»¯ng pháº§n Ä‘áº¥t khÃ´ng Ä‘Æ°á»£c cÃ´ng nháº­n</li>
<li>Pháº§n diá»‡n tÃ­ch sá»­ dá»¥ng chung</li>
<li>Pháº§n Ä‘áº¥t Ä‘Æ°á»£c quy hoáº¡ch lÃ m Ä‘Æ°á»ng, cá»™t Ä‘iá»‡n cao tháº¿, mÆ°Æ¡ng, Ä‘Ãª Ä‘iá»u, â€¦</li>
<li>ThÃ´ng tin Ä‘áº¥t Ä‘ang trong quÃ¡ trÃ¬nh tranh cháº¥p, kÃª biÃªn Ä‘á»ƒ báº£o Ä‘áº£m thi hÃ nh Ã¡n</li>
</ul>
<p>NgoÃ i ra, cÃ²n má»™t cÃ¡ch Ä‘á»ƒ thu tháº­p thÃ´ng tin ná»¯a lÃ  thÃ´ng qua hÃ ng xÃ³m, nhá»¯ng ngÆ°á»i buÃ´n bÃ¡n gáº§n Ä‘áº¥y Ä‘á»ƒ xin thÃ´ng tin.</p>
<h2 id="3-hÆ°á»›ng-Ä‘áº¥t">3. HÆ°á»›ng Ä‘áº¥t</h2>
<p>HÆ°á»›ng Ä‘áº¥t áº£nh hÆ°á»Ÿng nhiá»u tá»›i quÃ¡ trÃ¬nh sinh sá»‘ng vÃ¬ do áº£nh hÆ°á»Ÿng cá»§a giÃ³ mÃ¹a, khÃ­ háº­u, náº¯ng vÃ  cÃ¡c yáº¿u tá»‘ thá»i tiáº¿t, mÃ´i trÆ°á»ng.
HÆ°á»›ng Ä‘áº¥t hoÃ n toÃ n cÃ³ thá»ƒ kháº¯c phá»¥c báº±ng cÃ¡ch xÃ¢y cá»­a nhÃ /cá»•ng/cá»­a sá»• theo hÆ°á»›ng khÃ¡c. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ i thÃ´ng tin Ä‘Ãºng so vá»›i Ä‘áº¥t á»Ÿ miá»n nam Viá»‡t Nam.</p>
<h3 id="31-Ä‘Ã´ng">3.1. ÄÃ´ng</h3>
<p>HÆ°á»›ng Ä‘Ã´ng nháº­n náº¯ng sá»›m, tá»‘t cho sá»©c khá»e. Tuy nhiÃªn, cÃ³ thá»ƒ gáº·p khÃ³ khÄƒn trong viá»‡c phÆ¡i Ä‘á»“ vÃ  nháº­n mÆ°a vÃ o mÃ¹a mÆ°a.</p>
<h3 id="32-tÃ¢y">3.2. TÃ¢y</h3>
<p>HÆ°á»›ng tÃ¢y nháº­n Ã¡nh sÃ¡ng máº·t trá»i nhiá»u nháº¥t, nhÆ°ng cÃ³ thá»ƒ nÃ³ng vÃ  chÃ³i lá»i vÃ o buá»•i chiá»u. Cáº§n cÃ¢n nháº¯c cÃ¡c biá»‡n phÃ¡p chá»‘ng nÃ³ng.</p>
<h3 id="33-nam">3.3. Nam</h3>
<p>HÆ°á»›ng nam lÆ°u thÃ´ng giÃ³ tá»‘t, Ä‘Ã³n sÃ¡ng tá»‘i Æ°u. Tuy nhiÃªn, cáº§n Ä‘áº·c biá»‡t chÃº Ã½ Ä‘áº¿n nhiá»‡t Ä‘á»™ cao vÃ o mÃ¹a hÃ¨.</p>
<h3 id="34-báº¯c">3.4. Báº¯c</h3>
<p>HÆ°á»›ng báº¯c mÃ¡t máº» vÃ o mÃ¹a hÃ¨, nhÆ°ng cÃ³ thá»ƒ thiáº¿u Ã¡nh sÃ¡ng tá»± nhiÃªn. KhÃ´ng thuáº­n lá»£i cho viá»‡c trá»“ng cÃ¢y.</p>
<h2 id="4-tiá»‡n-Ã­ch-xung-quanh">4. Tiá»‡n Ã­ch xung quanh</h2>
<p>Tiá»‡n Ã­ch xung quanh Ä‘áº¥t áº£nh hÆ°á»Ÿng ráº¥t nhiá»u Ä‘áº¿n giÃ¡ trá»‹ vÃ  kháº£ nÄƒng sá»­ dá»¥ng cá»§a miáº¿ng Ä‘áº¥t. Má»™t sá»‘ tiá»‡n Ã­ch thÆ°á»ng mÃ¬nh hay cÃ¢y nháº¯c tá»›i:</p>
<ul>
<li>Chá»£ &amp; siÃªu thá»‹: gáº§n chá»£ thÃ¬ tiá»‡n, xÃ´ bá»“, nÃ¡o nhiá»‡t. Xa chá»£ thÃ¬ yÃªn tÄ©nh, báº¥t tiá»‡n.</li>
<li>Khu dÃ¢n cÆ° hiá»‡n há»¯u</li>
<li>Bá»‡nh viá»‡n</li>
<li>TrÆ°á»ng há»c</li>
<li>Giao thÃ´ng, Ä‘Æ°á»ng lá»›n, trá»¥c Ä‘Æ°á»ng xe hÃ ng, xe táº£i</li>
<li>Háº¡ táº§ng nÆ°á»›c, Ä‘iá»‡n, internet</li>
<li>BÃ£i rÃ¡c</li>
<li>NhÃ  mÃ¡y nhiá»‡t Ä‘iá»‡n, nhÃ  mÃ¡y than, cÃ´ng xÆ°á»Ÿng, lÃ² hoáº£ thiÃªu, nhÃ  mÃ¡y dá»‡t</li>
</ul>
<h2 id="kÃ­ch-thÆ°á»›c-hÃ¬nh-dáº¡ng-Ä‘áº¥t">KÃ­ch thÆ°á»›c hÃ¬nh dáº¡ng Ä‘áº¥t</h2>
<p>KÃ­ch thÆ°á»›c vÃ  hÃ¬nh dáº¡ng Ä‘áº¥t lÃ  nhá»¯ng yáº¿u tá»‘ quan trá»ng khi chá»n mua Ä‘áº¥t vÃ  cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n kháº£ nÄƒng sá»­ dá»¥ng vÃ  giÃ¡ trá»‹ cá»§a tÃ i sáº£n. CÃ¡c hÃ¬nh dáº¡ng Ä‘áº¥t thÃ´ng dá»¥ng:</p>
<ul>
<li>Äáº¥t vuÃ´ng váº¯n, khÃ´ng cáº¯t, khÃ´ng cong. Æ¯u tiÃªn hÃ¬nh vuÃ´ng, chá»¯ nháº­t.</li>
<li>Äáº¥t hÃ¬nh thang ná»Ÿ háº­u phÃ­a sau.</li>
</ul>
<p>NgoÃ i ra Ä‘áº¥t gÃ³c, Ä‘áº¥t cáº¡nh cÅ©ng Ä‘Æ°á»£c Æ°u tiÃªn.</p>
<h1 id="táº¡m-káº¿t">Táº¡m káº¿t</h1>
<p>DÃ¹ sao thÃ¬ coi Ä‘áº¥t cÅ©ng dá»±a khÃ¡ nhiá»u vÃ o Ã½ kiáº¿n chá»§ quan, nhÆ°ng náº¿u báº¡n xÃ¢y nhÃ  cÃ³ len chÃ¢n tÆ°á»ng cao 1m2, thÃ¬ nhÃ  báº¡n cháº¯c cháº¯n Ä‘áº¹p nhÃ©.</p>
 
        <div class="chapter-cover">
            <div class="chapter-name">
                <h1 class="no-break">GitlabCI vÃ  tuyá»‡t tháº¿ vÃµ há»c tá»‘i Æ°u pipeline</h1>
                <div class="no-break"><i>TÃ¡c giáº£:</i> Minh Monmen</div>
                <div class="no-break"><i>Chá»§ Ä‘á»:</i> DevOps, GitlabCI, Docker</div>
            </div>
            <div class="chapter-number">
                <h3 class="no-break">NgÃ y thá»©</h3>
                <h1 class="no-break">8</h1>
            </div>
        </div>
         <h1 id="gitlabci-vÃ -tuyá»‡t-tháº¿-vÃµ-há»c-tá»‘i-Æ°u-pipeline">GitlabCI vÃ  tuyá»‡t tháº¿ vÃµ há»c tá»‘i Æ°u pipeline</h1>
<p>Nhá»¯ng tuyá»‡t ká»¹ vÃµ cÃ´ng cÃ¡i tháº¿ vá»›i chiáº¿c gáº­y cá»§a lÃ£o Äƒn mÃ y - GitlabCI.</p>
<h2 id="first-things-first">First things first</h2>
<ul>
<li>Em Ä‘ang gáº·p váº¥n Ä‘á» vá»›i GitlabCI vÃ¬ build docker khÃ¡ cháº­m, lÃ m sao Ä‘á»ƒ tÄƒng tá»‘c nÃ³ lÃªn anh?</li>
<li>Má»—i láº§n code xong lÃ  em pháº£i chá» 10-15 phÃºt má»›i lÃªn Ä‘Æ°á»£c mÃ´i trÆ°á»ng dev, thay cÃ³ má»—i cÃ¡i áº£nh thÃ´i cÅ©ng build láº¡i cáº£ project!</li>
<li>Sao cháº¡y build báº±ng GitlabCI mÃ  thá»i gian láº¡i lÃ¢u gáº¥p Ä‘Ã´i build báº±ng Jenkin tháº¿ áº¡?</li>
</ul>
<p><img src="img/day-302/image-1.webp" alt="image.png"></p>
<p>ÄÃ¢y lÃ  nhá»¯ng cÃ¢u há»i, nhá»¯ng cÃ¢u cáº£m thÃ¡n trÃªn khÃ´ng Ã­t cÃ¡c diá»…n Ä‘Ã n, há»™i nhÃ³m cÃ´ng nghá»‡. NgÆ°á»i than thá»Ÿ thÃ¬ cÅ©ng tráº£i rá»™ng tá»« Dev, System, DevOps,â€¦ chá»© khÃ´ng pháº£i Ã­t. Äiá»u nÃ y chá»©ng tá» máº·c dÃ¹ GitlabCI tá»« lÃ¢u Ä‘Ã£ trá»Ÿ thÃ nh tool CI â€œquá»‘c dÃ¢nâ€ Ä‘Æ°á»£c Ä‘Ã´ng Ä‘áº£o táº§ng lá»›p IT sá»­ dá»¥ng, tháº¿ nhÆ°ng váº«n cÃ³ ráº¥t nhiá»u ngÆ°á»i loay hoay khÃ´ng biáº¿t lÃ m tháº¿ nÃ o Ä‘á»ƒ sá»­ dá»¥ng GitlabCI cho há»£p lÃ½ vÃ  quan trá»ng hÆ¡n lÃ  cho nÃ³ nhanh.</p>
<p>Náº¯m báº¯t Ä‘Æ°á»£c nhu cáº§u Ä‘Ã³, táº¡i háº¡ - <strong>Minh Monmen</strong> - thÃ¢n lÃ  chÃ¢n le ve trÃ  nÆ°á»›c Ä‘á»¥ng gÃ¬ lÃ m Ä‘Ã³ trong CÃ¡i Bang thÃ´i nhÆ°ng Ä‘Æ°á»£c cÃ¡i dÃ¹ng GitlabCI cÅ©ng ngÃ³t nghÃ©t 8 mÃ¹a bÃ¡nh chÆ°ng nÃªn nay lÃ£nh trá»ng trÃ¡ch biÃªn soáº¡n cuá»‘n bÃ­ kÃ­p tuyá»‡t tháº¿ vÃµ cÃ´ng xung quanh chiáº¿c <strong>Äáº£ Cáº©u Bá»•ng</strong> quen thuá»™c nÃ y.</p>
<p>Vá»‘n lÃ¢u nay táº¡i háº¡ mai danh áº©n tÃ­ch trÃªn giang há»“, chá»‰ sinh hoáº¡t á»Ÿ vÃ i há»™i kÃ­n chuyÃªn chat chit trong giá» hÃ nh chÃ­nh nhÆ° webu, DevOps VN,â€¦ Tháº¿ nhÆ°ng tháº¥y tháº¿ sá»± nguy cáº¥p, dÃ¢n chÃºng láº§m than, táº¡i háº¡ lÃ²ng Ä‘au nhÆ° cáº¯t, nÆ°á»›c máº¯t Ä‘áº§m Ä‘Ã¬a, chá»‰ cÄƒm tá»©c chÆ°a xáº£â€¦ Ã­ lá»™n bÃ i, chá»‰ háº­n khÃ´ng thá»ƒ láº­p tá»©c cá»©u khá»‘n phÃ² nguy, tráº¥n an bÃ¡ tÃ¡nh mÃ  chá»‰ cÃ³ thá»ƒ ngá»“i Ä‘Ã¢y soáº¡n ra cuá»‘n tuyá»‡t tháº¿ vÃµ há»c nÃ y. ThÃ´i thÃ¬ kÃ­nh mong chÆ° vá»‹ huynh Ä‘Ã i cÃ³ Ä‘i qua Ä‘Ã¢y tháº£ cho 1 upvote vÃ  vÃ i lá»i bÃ¬nh pháº©m (comment) Ä‘á»ƒ bÃ­ kÃ­p cÃ¡i bang nÃ y hoÃ n thiá»‡n hÆ¡n.</p>
<p>BÃ­ kÃ­p nÃ y sáº½ táº­p trung vÃ o nhá»¯ng váº¥n Ä‘á» xung quanh 1 mÃ´n vÃµ duy nháº¥t: <strong>Build docker image vá»›i GitlabCI</strong>.</p>
<h2 id="cáº¥p-Ä‘á»™-1-setup-self-hosted-gitlabci-runner-Ä‘á»ƒ-build-Ä‘Æ°á»£c-docker">Cáº¥p Ä‘á»™ 1: Setup self-hosted GitlabCI runner Ä‘á»ƒ build Ä‘Æ°á»£c docker</h2>
<p>Äá»ƒ Ä‘á»c Ä‘Æ°á»£c pháº§n nÃ y thÃ¬ táº¡i háº¡ sáº½ ngáº§m hiá»ƒu quÃ½ vá»‹ Ä‘á»™c giáº£ Ä‘Ã£ <strong>biáº¿t GitlabCI lÃ  cÃ¡i gÃ¬</strong>, <strong>Ä‘Ã£ dÃ¹ng thá»­ GitlabCI</strong> vÃ  <strong>hiá»ƒu Ä‘Æ°á»£c self-hosted runner</strong> nghÄ©a lÃ  gÃ¬ rá»“i. VÃ  cÅ©ng ngáº§m hiá»ƒu luÃ´n lÃ  quÃ½ vá»‹ Ä‘Ã£ Ä‘á»c ká»¹ hÆ°á»›ng dáº«n nÃ y cá»§a gitlab vá» nhá»¯ng phÆ°Æ¡ng phÃ¡p setup runner Ä‘á»ƒ build Ä‘Æ°á»£c docker image: <a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">https://docs.gitlab.com/ee/ci/docker/using_docker_build.html</a>.</p>
<p>Äáº¡i khÃ¡i thÃ¬ Ä‘á»ƒ cháº¡y Ä‘Æ°á»£c lá»‡nh build cá»§a docker thÃ¬ chÃºng ta cáº§n 1 cÃ¡i <strong>docker daemon</strong> Ä‘Æ°á»£c cháº¡y á»Ÿ Ä‘Ã¢u Ä‘Ã³ vÃ  Gitlab Ä‘Ã£ nÃ³i ráº¥t rÃµ vá» 3 phÆ°Æ¡ng phÃ¡p chÃ­nh dÃ¹ng Ä‘á»ƒ build docker trong job lÃ :</p>
<ul>
<li>Sá»­ dá»¥ng <strong>shell executor</strong>: DÃ¹ng <strong>shell cá»§a host</strong> do Ä‘Ã³ sáº½ cÃ³ quyá»n truy cáº­p Ä‘áº¿n <strong>docker daemon cá»§a host</strong>.</li>
<li>Sá»­ dá»¥ng <strong>Docker-in-Docker</strong>: <strong>Cháº¡y script trong container</strong> báº±ng docker / kubernetes executor vÃ  <strong>sá»­ dá»¥ng docker daemon cá»§a 1 container Ä‘áº·c biá»‡t</strong> cháº¡y kÃ¨m lÃ  <strong>docker-in-docker</strong> (dind)</li>
<li><strong>Mount docker socket</strong> vÃ o container: ÄÃ¢y lÃ  kiá»ƒu lai giá»¯a 2 tháº±ng trÃªn, <strong>cháº¡y script trong container</strong> báº±ng docker executor nhÆ°ng láº¡i sá»­ dá»¥ng <strong>docker daemon cá»§a host</strong> thÃ´ng qua viá»‡c mount cÃ¡i <code>/var/run/docker.sock</code>.</li>
</ul>
<blockquote>
<p><em>CÃ²n 2 phÆ°Æ¡ng phÃ¡p ngoÃ i lá» ná»¯a lÃ  dÃ¹ng nhá»¯ng tháº±ng khÃ´ng pháº£i docker Ä‘á»ƒ build image nhÆ° lÃ  kaniko hay lÃ  buildah thÃ¬ táº¡i háº¡ sáº½ khÃ´ng Ä‘á» cáº­p á»Ÿ Ä‘Ã¢y vÃ¬ Ä‘Æ¡n giáº£n lÃ  táº¡i háº¡ xÃ i thá»­ lÃ¢u rá»“i vÃ  nÃ³ cháº­m quÃ¡, khÃ´ng phÃ¹ há»£p cho 1 bÃ i vá» tá»‘i Æ°u tá»‘c Ä‘á»™ nhÆ° nÃ y.</em> </p>
</blockquote>
<p>Má»—i phÆ°Æ¡ng phÃ¡p thÃ¬ Ä‘á»u cÃ³ Ä‘iá»ƒm lá»£i háº¡i riÃªng. KhÃ´ng cÃ³ phÆ°Æ¡ng phÃ¡p nÃ o lÃ  chuáº©n chá»‰ mÃ  viá»‡c lá»±a chá»n 1 trong 3 phÆ°Æ¡ng phÃ¡p nÃ y dá»±a trÃªn requirement cá»§a tá»«ng há»‡ thá»‘ng vÃ  tradeoff mÃ  thÃ´i.</p>
<p>VÃ­ dá»¥ nhÆ° vá»›i há»‡ thá»‘ng nghÃ¨o khÃ³ cá»§a táº¡i háº¡ chá»‰ cÃ³ 1 con VPS nho nhá» dÃ¹ng Ä‘á»ƒ cháº¡y runner thÃ¬ táº¡i háº¡ sáº½ chá»n cÃ¡ch thá»© 3 (mount docker socket) vÃ¬:</p>
<ul>
<li>CÃ¡ch dÃ¹ng <strong>shell executor</strong> thÃ¬ khÃ´ng khoÃ¡i vÃ¬ nÃ³ khÃ´ng isolate Ä‘Æ°á»£c mÃ´i trÆ°á»ng cháº¡y script cá»§a táº¡i háº¡ (do cháº¡y chung trÃªn shell cá»§a host). Do Ä‘Ã³ nÃ³ phá»¥ thuá»™c ráº¥t nhiá»u vÃ o mÃ´i trÆ°á»ng cá»§a host. Cháº³ng háº¡n nhÆ° host cháº¡y node ver nÃ o blablo. Bá» qua ngay vÃ  luÃ´n.</li>
<li>DÃ¹ng <strong>Docker-in-Docker</strong> thÃ¬ táº¡i háº¡ Ä‘Ã£ tá»«ng setup ráº¥t nhiá»u, cáº£ trÃªn VM cáº£ trÃªn cÃ¡c loáº¡i K8S managed nhÆ° GKE, EKS hay K8S tá»± setup báº±ng kops. Suck! CÃ¡i vÅ©ng láº§y vá» káº¿t ná»‘i TLS nÃ³ quÃ¡ lÃ  sÃ¢u, máº¥t quÃ¡ nhiá»u thá»i gian quÃ½ bÃ¡u cá»§a táº¡i háº¡ vÃ  team. Nháº¥t lÃ  cÃ¡i giai Ä‘oáº¡n docker á»Ÿ version loanh quanh 1.19 nÃ³ lá»—i lÃªn lá»—i xuá»‘ng, vÃ i hÃ´m láº¡i lá»—i tÃ¨ le mÃ  cháº£ thay Ä‘á»•i gÃ¬ cÅ©ng cháº£ hiá»ƒu táº¡i sao. ThÃªm cÃ¡i lÃ  nÃ³ cháº¡y storage trong docker nÃªn cÅ©ng cháº­m Ä‘i so vá»›i 2 cÃ¡ch build cÃ²n láº¡i kha khÃ¡. ThÃ´i thÃ¬ há»‡ thá»‘ng lÃ  cá»§a anh em, nÃªn anh em cÃ³ thá»ƒ cÃ¢n nháº¯c xÃ i cÅ©ng ok, cÃ¡c phÆ°Æ¡ng phÃ¡p trong cuá»‘n bÃ­ kÃ­p nÃ y váº«n cÃ³ thá»ƒ Ã¡p dá»¥ng bÃ¬nh thÆ°á»ng.</li>
</ul>
<p><img src="img/day-302/image-2.webp" alt="image.png"></p>
<p>Chá»n phÆ°Æ¡ng phÃ¡p mount docker socket vÃ¬ nÃ³ Ä‘Æ¡n giáº£n, nÃ³ work out of the box vÃ  ráº¥t Ã­t pháº£i thay Ä‘á»•i file gitlab-ci config (nhÆ° dind lÃ  thÃªm env rá»“i service tÃ¡ láº£). Táº¥t nhiÃªn nÃ³ cÃ³ váº¥n Ä‘á» vá» security vá»›i host, nhÆ°ng táº§m quan trá»ng cá»§a cÃ¡i váº¥n Ä‘á» Ä‘Ã³ vá»›i táº¡i háº¡ khÃ´ng quÃ¡ to Ä‘á»ƒ láº¥n Ã¡t khoáº£ng thá»i gian tiáº¿t kiá»‡m Ä‘Æ°á»£c nhá» sá»­ dá»¥ng nÃ³.</p>
<p>Ok, sau khi chÃºng ta Ä‘Ã£ cÃ³ 1 con VPS cÃ³ cÃ i docker version má»›i nháº¥t thÃ¬ start gitlab runner vá»›i cÃ¢u lá»‡nh sau:</p>
<pre><code class="language-bash">$ docker run -d --name gitlab-runner --restart always \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v /srv/gitlab-runner/config:/etc/gitlab-runner \
    gitlab/gitlab-runner:alpine
</code></pre>
<p>Sau Ä‘Ã³ chÃºng ta vÃ´ Gitlab, táº¡o má»›i 1 runner cho project hoáº·c cho group. Vá»›i flow cáº¥p token má»›i cá»§a GitlabCI thÃ¬ ta sáº½ nháº­n Ä‘Æ°á»£c <code>authentication token</code> thay vÃ¬ <code>registration token</code>. Do váº­y sáº½ cáº§n cháº¡y command sau Ä‘á»ƒ Ä‘Äƒng kÃ½ runner:</p>
<pre><code class="language-bash">$ <span class="hljs-built_in">export</span> RUNNER_AUTH_TOKEN=&lt;your_auth_token&gt;
$ docker run --<span class="hljs-built_in">rm</span> -it -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:alpine register --token <span class="hljs-variable">$RUNNER_AUTH_TOKEN</span>
</code></pre>
<p><img src="img/day-302/image-3.png" alt="image.png"></p>
<p>Xong. Runner cá»§a chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c config vÃ  tá»± Ä‘á»™ng cháº¡y, cÃ¡c báº¡n cÃ³ thá»ƒ cháº¡y <code>docker logs gitlab-runner</code> Ä‘á»ƒ tháº¥y config Ä‘Ã£ Ä‘Æ°á»£c reload. Tuy nhiÃªn config máº·c Ä‘á»‹nh nÃ y chÆ°a mount docker socket vÃ´ job cho chÃºng ta, do Ä‘Ã³ hÃ£y sá»­a láº¡i file config <code>/srv/gitlab-runner/config/config.toml</code> chÃºt Ä‘á»‰nh:</p>
<pre><code>concurrent = 1
check_interval = 0
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = &quot;test-runner&quot;
  url = &quot;https://gitlab.com&quot;
  id = 1234567
  token = &quot;&lt;your_auth_token&gt;&quot;
  token_obtained_at = 2023-12-28T18:10:15Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = &quot;docker&quot;
  [runners.cache]
    MaxUploadedArchiveSize = 0
  [runners.docker]
    tls_verify = false
    image = &quot;docker:24.0.7&quot;
    privileged = false
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;, &quot;/cache&quot;]
    shm_size = 0
    network_mtu = 0
    pull_policy = &quot;if-not-present&quot;
</code></pre>
<blockquote>
<p>Tip trick: trong config nÃ y náº¿u Ä‘á»ƒ Ã½ cÃ¡c báº¡n sáº½ tháº¥y ngoÃ i thÃªm volume docker socket ra thÃ¬ cÃ²n cÃ³ thÃªm 1 cÃ¡i config <code>pull_policy = &quot;if-not-present&quot;</code>. Config nÃ y dÃ¹ng Ä‘á»ƒ háº¡n cháº¿ viá»‡c runner láº§n nÃ o build cÅ©ng pháº£i pull láº¡i cÃ¡c image cÆ¡ báº£n nhÆ° docker, dind hay node mÃ  dÃ¹ng luÃ´n image vá»›i tag Ä‘Ã³ cÃ³ sáºµn trÃªn host. CÃ¡i nÃ y <strong>tiáº¿t kiá»‡m Ä‘Æ°á»£c ráº¥t nhiá»u</strong> thá»i gian vÃ  tiá»n báº¡c má»—i khi job cháº¡y Ä‘áº¥y nhÃ©. NgoÃ i ra cÃ²n háº¡n cháº¿ viá»‡c bá»‹ Docker hub rate limit vÃ¬ pull quÃ¡ nhiá»u ná»¯a.</p>
</blockquote>
<blockquote>
<p>Tips 2: Sau khi edit config gitlab-runner sáº½ tá»± reload láº¡i chá»© khÃ´ng cáº§n restart thá»§ cÃ´ng Ä‘Ã¢u nhÃ©.</p>
</blockquote>
<p>Tá»›i Ä‘Ã¢y lÃ  xong, thá»­ ngay vÃ  luÃ´n vá»›i project <code>next-ecommerce</code> sá»­ dá»¥ng nextjs clone tá»« bÃªn github vá»›i <code>Dockerfile</code> simple sau:</p>
<pre><code class="language-Dockerfile"><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">3000</span>

<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> yarn install</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> yarn build</span>

<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;npm&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>]</span>
</code></pre>
<pre><code class="language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">docker:24.0.7</span>

<span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">IMAGE_TAG:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">gitlab-ci-token</span> <span class="hljs-string">-p</span> <span class="hljs-string">$CI_JOB_TOKEN</span> <span class="hljs-string">registry.gitlab.com</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG</span>
</code></pre>
<p>Káº¿t quáº£:</p>
<p><img src="img/day-302/image-4.webp" alt="image.png"></p>
<h2 id="cáº¥p-Ä‘á»™-2-tá»‘i-Æ°u-docker-layer-cache">Cáº¥p Ä‘á»™ 2: Tá»‘i Æ°u docker layer cache</h2>
<p>Táº¥t nhiÃªn, app trÃªn cá»§a chÃºng ta chá»‰ lÃ  1 cÃ¡i example app, nÃªn thá»i gian install dependencies vÃ  build ráº¥t nhanh. Cháº¡y láº§n Ä‘áº§u khÃ´ng cache cá»§ng gÃ¬ máº¥t cÃ³ 2 phÃºt rÆ°á»¡i.</p>
<p>Tuy nhiÃªn Ä‘áº¿n Ä‘Ã¢y tá»•ng thá»ƒ luá»“ng CI/CD sáº½ xuáº¥t hiá»‡n cÃ¡c váº¥n Ä‘á» chÆ°a tá»‘i Æ°u:</p>
<ul>
<li><strong>Docker image náº·ng</strong></li>
<li><strong>Thá»i gian má»—i láº§n build láº¡i sáº½ giá»‘ng nhÆ° láº§n Ä‘áº§u tiÃªn</strong> dÃ¹ chÃºng ta thay Ä‘á»•i code Ã­t hay nhiá»u (hay tháº­m chÃ­ khÃ´ng Ä‘á»•i gÃ¬)</li>
<li><strong>ÄÃ¡nh tag docker image chÆ°a tá»‘t</strong>: Máº·c dÃ¹ tag image theo commit sha lÃ  1 cÃ¡ch lÃ m phá»• biáº¿n bá»Ÿi nÃ³ Ä‘áº£m báº£o tÃ¡ch biá»‡t docker image giá»¯a cÃ¡c láº§n build, cÅ©ng Ä‘áº£m báº£o container orchestration sáº½ pull Ä‘Ãºng image khi cháº¡y. Tuy nhiÃªn kiá»ƒu tag Ä‘Æ¡n giáº£n nÃ y sáº½ lÃ m docker registry sáº½ Ä‘áº§y lÃªn nhanh chÃ³ng mÃ  khÃ´ng cÃ³ rule cleanup nÃ o phÃ¹ há»£p, khÃ´ng thá»ƒ cleanup theo tá»«ng mÃ´i trÆ°á»ng hay tá»«ng loáº¡i image vÃ¬ chá»‰ cÃ³ 1 loáº¡i tag duy nháº¥t.</li>
</ul>
<p>Äá»ƒ giáº£i quyáº¿t nhá»¯ng váº¥n Ä‘á» nÃ y thÃ¬ má»i ngÆ°á»i hÃ£y Ä‘á»c thÃªm bÃ i viáº¿t nÃ y: Docker image in production - cÃ¢u chuyá»‡n 1GB hay 100MB - <a href="https://viblo.asia/p/docker-image-in-production-cau-chuyen-1gb-hay-100mb-LzD5dXyE5jY">https://viblo.asia/p/docker-image-in-production-cau-chuyen-1gb-hay-100mb-LzD5dXyE5jY</a> vá» cÃ¡ch giáº£m dung lÆ°á»£ng docker image cÅ©ng nhÆ° tá»• chá»©c láº¡i layer trong Dockerfile Ä‘á»ƒ <strong>cÃ³ thá»ƒ cache</strong>.</p>
<p>Táº¡i háº¡ sáº½ khÃ´ng nÃ³i láº¡i nhá»¯ng thá»© Ä‘Ã£ cÃ³ trong bÃ i viáº¿t trÃªn, tuy nhiÃªn chá»— nÃ y sáº½ nÃ³i thÃªm 1 chÃºt vá» nhá»¯ng layer thÆ°á»ng xuáº¥t hiá»‡n trong 1 application bÃ¬nh thÆ°á»ng:</p>
<ul>
<li><strong>Static config (WORKDIR, EXPOSE,â€¦)</strong> lÃ  nhá»¯ng layer gáº§n nhÆ° khÃ´ng bao giá» thay Ä‘á»•i, sáº½ Ä‘Æ°á»£c Ä‘áº·t Ä‘áº§u tiÃªn.</li>
<li><strong>System dependencies (RUN apk add, apt install,â€¦)</strong> lÃ  nhá»¯ng layer cÃ i Ä‘áº·t mÃ´i trÆ°á»ng vÃ  nhá»¯ng dependencies cá»§a system, ráº¥t ráº¥t Ã­t thay Ä‘á»•i xáº¿p tiáº¿p theo.</li>
<li><strong>Application dependencies (RUN composer install, npm install,â€¦)</strong> lÃ  nhá»¯ng layer cÃ i Ä‘áº·t cÃ¡c dependencies cá»§a application, cÃ³ táº§n suáº¥t thay Ä‘á»•i lá»›n hÆ¡n chÃºt Ã­t tÃ¹y thuá»™c vÃ o dev cÃ i Ä‘áº·t thÃªm thÆ° viá»‡n gÃ¬ cho project. á» Ä‘Ã¢y package manager sáº½ thÆ°á»ng cáº§n 1 file config (vd package.json, composer.json,â€¦) vÃ  1 file lock (package-lock.json, yarn.lock, composer.lock,â€¦) Ä‘á»ƒ khÃ³a version thÆ° viá»‡n. 2 file nÃ y sáº½ Ä‘Æ°á»£c copy trÆ°á»›c vÃ  cÃ i Ä‘áº·t Ä‘á»ƒ táº­n dá»¥ng Ä‘Æ°á»£c cache khi chá»‰ cÃ³ code thay Ä‘á»•i. CÃ³ ráº¥t nhiá»u project config sai, ignore file lock trong gitignore dáº«n Ä‘áº¿n loáº¡n version, lÃºc build Ä‘Æ°á»£c lÃºc khÃ´ng,â€¦ CÃ¡c báº¡n nhá»› Ä‘á»ƒ Ã½ ká»¹ vÃ¬ file lock lÃ  thá»© <strong>cá»±c ká»³ quan trá»ng</strong> Ä‘Ã³ nhÃ©. NgÃ´n ngá»¯ nÃ o, package manager nÃ o cÅ©ng hÆ°á»›ng Ä‘áº¿n implement cÆ¡ cháº¿ lock version nÃ y.</li>
<li><strong>Application code (COPY . /app)</strong> lÃ  nhá»¯ng layer chá»©a code cá»§a application, cÃ³ táº§n suáº¥t thay Ä‘á»•i lá»›n nháº¥t, tá»« layer nÃ y trá»Ÿ Ä‘i thÆ°á»ng lÃ  khÃ´ng thá»ƒ cache Ä‘Æ°á»£c báº±ng docker layer. NgÆ°á»i ta chá»‰ háº¡n cháº¿ nhá»¯ng láº§n build khÃ´ng cáº§n thiáº¿t (kiá»ƒu chá»‰ sá»­a README.md, sá»­a gitlab-ci.yml,â€¦) báº±ng viá»‡c ignore nhá»¯ng file nÃ y trong <code>.dockerignore</code> Ä‘á»ƒ khi build docker khÃ´ng tháº¥y sá»± thay Ä‘á»•i code vÃ  sá»­ dá»¥ng cache.</li>
<li><strong>Application build (RUN npm build, go buildâ€¦)</strong>: má»™t sá»‘ application sáº½ cáº§n build trÆ°á»›c khi cháº¡y. ÄÃ¢y cÃ³ thá»ƒ lÃ  nhá»¯ng bÆ°á»›c ráº¥t tá»‘n thá»i gian, nhÆ°ng khÃ´ng cache Ä‘Æ°á»£c báº±ng Docker. Do Ä‘Ã³ chÃºng ta sáº½ xem xÃ©t tá»‘i Æ°u quÃ¡ trÃ¬nh nÃ y á»Ÿ cáº¥p Ä‘á»™ cao hÆ¡n.</li>
</ul>
<p>Sau khi Ã¡p dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p trong bÃ i viáº¿t trÃªn thÃ¬ chÃºng ta cÃ³ 1 cÃ¡i <code>Dockerfile</code> Ä‘Æ°á»£c tá»‘i Æ°u hÆ¡n nhÆ° sau:</p>
<pre><code class="language-Dockerfile"><span class="hljs-comment"># Builder stage</span>
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>-alpine AS builder

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>

<span class="hljs-keyword">COPY</span><span class="language-bash"> package.json yarn.lock ./</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> yarn install --pure-lockfile</span>
<span class="hljs-comment"># ^ Cache docker layer above this line</span>

<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> yarn build</span>
<span class="hljs-comment"># Remove dev dependencies</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> yarn install --pure-lockfile --prod </span>

<span class="hljs-comment"># Runtime stage</span>
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>-alpine

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">3000</span>

<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/package.json /app/next.config.js /app/yarn.lock ./</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/node_modules ./node_modules</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/public ./public</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/.next ./.next</span>

<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;npm&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>]</span>
</code></pre>
<p>Váº­y lÃ  docker image nÃ y Ä‘Ã£ <strong>cÃ³ thá»ƒ táº­n dá»¥ng Ä‘Æ°á»£c cache docker layer</strong> trong quÃ¡ trÃ¬nh build. CÃ¡c báº¡n cÃ³ thá»ƒ kiá»ƒm tra trÃªn chÃ­nh mÃ¡y cá»§a mÃ¬nh báº±ng cÃ¡ch thá»­ Ä‘á»•i code vÃ  build láº¡i. NgoÃ i ra nÃ³ cÅ©ng Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u vá» máº·t dung lÆ°á»£ng image Ä‘á»ƒ runtime image nháº¹ nháº¥t cÃ³ thá»ƒ. </p>
<p><img src="img/day-302/image-5.jpg" alt="image.png"></p>
<p>10 Ä‘iá»ƒm, <strong>NHÆ¯NG</strong> váº§y lÃ  chÆ°a Ä‘á»§ vá»›i quÃ¡ trÃ¬nh CI/CD. Bá»Ÿi vÃ¬ Docker layer <strong>cÃ³ thá»ƒ</strong> cache Ä‘Æ°á»£c rá»“i, nhÆ°ng Ä‘áº¥y lÃ  vá»›i trÆ°á»ng há»£p báº¡n Ä‘ang build trÃªn <strong>1 mÃ¡y cá»§a báº¡n</strong>, cÃ¡i <strong>docker daemon</strong> nÃ³ tháº¥y cÃ³ image layer cÅ© thÃ¬ nÃ³ dÃ¹ng. CÃ²n vá»›i mÃ´i trÆ°á»ng build cá»§a CI/CD thÃ¬ cÃ³ nhiá»u lÃ½ do Ä‘á»ƒ Ä‘iá»u nÃ y khÃ´ng xáº£y ra:</p>
<ul>
<li>Sá»­ dá»¥ng docker-in-docker. LÃºc nÃ y docker daemon Ä‘Æ°á»£c cháº¡y trong container, vÃ  khÃ´ng lÆ°u láº¡i gÃ¬ cáº£ giá»¯a cÃ¡c láº§n build. Do Ä‘Ã³ khÃ´ng dÃ¹ng Ä‘Æ°á»£c cache.</li>
<li>Sá»­ dá»¥ng mount docker.sock giá»‘ng táº¡i háº¡ á»Ÿ trÃªn, lÃºc nÃ y docker daemon cá»§a mÃ¡y build sáº½ cháº¡y trÃªn host, vÃ  cÃ³ thá»ƒ lÆ°u láº¡i cache giá»¯a cÃ¡c láº§n build <strong>trÃªn cÃ¹ng 1 mÃ¡y</strong>. Náº¿u cÃ¡c báº¡n setup runner khÃ¡c cháº¡y trÃªn host khÃ¡c thÃ¬ cache cÅ©ng khÃ´ng dÃ¹ng Ä‘Æ°á»£c. Hoáº·c lÃ¢u lÃ¢u pháº£i clear bá»›t space trÃªn con runner (nÃ³ ráº¥t lÃ  nhanh full disk nhÃ©) thÃ¬ cÅ©ng sáº½ khÃ´ng dÃ¹ng cache cÅ© ná»¯a. Váº­y lÃ  cache bá»‹ phá»¥ thuá»™c vÃ o con host cháº¡y runner khÃ¡ nhiá»u.</li>
</ul>
<p>LÃºc nÃ y hÃ£y chÆ¡i theo hÆ°á»›ng dáº«n nÃ y cá»§a Gitlab: <a href="https://docs.gitlab.com/ee/ci/docker/docker_layer_caching.html">https://docs.gitlab.com/ee/ci/docker/docker_layer_caching.html</a>. Ã tÆ°á»Ÿng á»Ÿ Ä‘Ã¢y lÃ  sáº½ khÃ´ng phá»¥ thuá»™c vÃ o viá»‡c cháº¡y build docker báº±ng dind hay lÃ  docker sock mÃ  sáº½ chá»§ Ä‘á»™ng save láº¡i docker image trÃªn registry vÃ  pull vá» khi báº¯t Ä‘áº§u build. </p>
<pre><code class="language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">docker:24.0.7</span>

<span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">IMAGE_TAG_LATEST:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span>
  <span class="hljs-attr">IMAGE_TAG:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">gitlab-ci-token</span> <span class="hljs-string">-p</span> <span class="hljs-string">$CI_JOB_TOKEN</span> <span class="hljs-string">registry.gitlab.com</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">$IMAGE_TAG_LATEST</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$IMAGE_TAG_LATEST</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG_LATEST</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG_LATEST</span>
</code></pre>
<p>Táº¥t nhiÃªn lÃ  quÃ¡ trÃ¬nh pull vÃ  push image lÃªn registry sáº½ tá»‘n thÃªm thá»i gian / network. Tuy nhiÃªn khi build nhá»¯ng project lá»›n hÆ¡n cÃ³ thá»i gian build from scratch tá»›i 10-20p hay cáº£ tiáº¿ng thÃ¬ cÃ¡c báº¡n sáº½ tháº¥y cÃ¡i nÃ y hoÃ n toÃ n cháº¥p nháº­n Ä‘Æ°á»£c nhÃ©.</p>
<p><img src="img/day-302/image-6.webp" alt="image.png"></p>
<p>Oops, nhÆ°ng cÃ³ gÃ¬ Ä‘Ã³ sai sai, chá»— nÃ y chá»‰ Ä‘á»•i code thÃ´i mÃ  thá»i gian build khÃ´ng khÃ¡c nhiá»u so vá»›i lÃºc Ä‘áº§u. Kiá»ƒm tra ra thÃ¬ hÃ³a ra lÃ  Ä‘oáº¡n <code>yarn install</code> váº«n chÆ°a Ä‘Æ°á»£c cache (trong khi Ä‘Ã¡ng láº½ lÃ  pháº£i Ä‘Æ°á»£c cache rá»“i). Táº¡i sao váº­y?</p>
<p><img src="img/day-302/image-7.png" alt="image.png"></p>
<p>Chá»— nÃ y tÃ© ra lÃ  do cÆ¡ cháº¿ cá»§a tháº±ng <strong>multi-stage</strong> build lÃ  <strong>chá»‰ lÆ°u láº¡i image á»Ÿ stage cuá»‘i cÃ¹ng</strong>. Do Ä‘Ã³ nhá»¯ng layer trong stage builder <strong>khÃ´ng Ä‘Æ°á»£c lÆ°u láº¡i</strong>, do Ä‘Ã³ khÃ´ng Ä‘Æ°á»£c cache dÃ¹ Ä‘á»§ Ä‘iá»u kiá»‡n Ä‘á»ƒ sá»­ dá»¥ng. Ok váº­y thÃ¬ chÃºng ta láº¡i tiáº¿p tá»¥c lÆ°u láº¡i thÃªm cáº£ cÃ¡i builder image ná»¯a báº±ng chá»‰ dáº«n <code>--target</code> khi cháº¡y command <code>docker build</code>. Chá»— nÃ y ta cÅ©ng khÃ´ng cáº§n thiáº¿t pháº£i lÆ°u láº¡i image runtime latest ná»¯a vÃ¬ sáº½ cáº§n táº­p trung á»Ÿ cache trong stage builder.</p>
<blockquote>
<p>Má»™t lá»—i ná»¯a chá»— nÃ y cÃ¡c báº¡n sáº½ gáº·p lÃ  Ä‘á»ƒ xÃ i Ä‘Æ°á»£c <code>--cache-from</code> thÃ¬ pháº£i enable buildkit vÃ  thÃªm <code>--build-arg BUILDKIT_INLINE_CACHE=1</code> thÃ¬ má»›i nháº­n nhÃ©. <strong>KHÃ”NG CÃ“ LÃ€ NÃ“ KHÃ”NG WORK ÄÃ‚U</strong></p>
</blockquote>
<pre><code class="language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">docker:24.0.7</span>

<span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">IMAGE_TAG_BUILDER:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE/builder:latest</span>
  <span class="hljs-attr">IMAGE_TAG:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span>
  <span class="hljs-attr">DOCKER_BUILDKIT:</span> <span class="hljs-string">&#x27;1&#x27;</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">gitlab-ci-token</span> <span class="hljs-string">-p</span> <span class="hljs-string">$CI_JOB_TOKEN</span> <span class="hljs-string">registry.gitlab.com</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--build-arg</span> <span class="hljs-string">BUILDKIT_INLINE_CACHE=1</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">--target=builder</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--build-arg</span> <span class="hljs-string">BUILDKIT_INLINE_CACHE=1</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span>
</code></pre>
<p>Ok, chá»— nÃ y Ä‘Ã£ á»•n Ã¡p rá»“i :D. CÃ¡c báº¡n cÃ³ thá»ƒ thá»­ build láº¡i vÃ  kiá»ƒm tra xem cÃ³ cache Ä‘Æ°á»£c chÆ°a.</p>
<p><img src="img/day-302/image-8.webp" alt="image.png"></p>
<h2 id="cáº¥p-Ä‘á»™-3-tá»‘i-Æ°u-bÆ°á»›c-build-code-báº±ng-viá»‡c-extract-folder-cache">Cáº¥p Ä‘á»™ 3: Tá»‘i Æ°u bÆ°á»›c build code báº±ng viá»‡c extract folder cache</h2>
<p>Äa sá»‘ viá»‡c tá»‘i Æ°u gitlab-ci cá»§a cÃ¡c báº¡n sáº½ dá»«ng láº¡i á»Ÿ cáº¥p Ä‘á»™ 2. Pháº§n lá»›n cÃ¡c bÃ­ kÃ­p tá»‘i Æ°u trÃ´i ná»•i trÃªn thá»‹ trÆ°á»ng cÅ©ng thÆ°á»ng chá»‰ dá»«ng láº¡i á»Ÿ cáº¥p Ä‘á»™ nÃ y vÃ¬ nÃ³ Ä‘Ã£ Ä‘Ã¡p á»©ng Ä‘Æ°á»£c Ä‘a sá»‘ yÃªu cáº§u vÃ  cÃ¡c tÃ¬nh huá»‘ng thá»±c táº¿ rá»“i. Nhá»¯ng gÃ¬ táº¡i háº¡ sáº¯p lÃ m tiáº¿p theo Ä‘Ã¢y lÃ  nhá»¯ng bÆ°á»›c tá»‘i Æ°u cao hÆ¡n nhÆ°ng cÃ³ thá»ƒ khÃ´ng cáº§n thiáº¿t hoáº·c khÃ´ng quÃ¡ hiá»‡u quáº£ vá»›i project cá»§a cÃ¡c báº¡n. á» Ä‘Ã¢y cÃ¡c báº¡n hÃ£y tá»± cÃ¢n nháº¯c vÃ  thá»­ nghiá»‡m vá»›i tech stack cá»§a mÃ¬nh xem lÃ m Ä‘áº¿n Ä‘Ã¢u lÃ  há»£p lÃ½.</p>
<p>á» káº¿t quáº£ cá»§a cáº¥p Ä‘á»™ trÆ°á»›c, cÃ¡i chÃºng ta Ä‘áº¡t Ä‘Æ°á»£c lÃ  cache Ä‘Æ°á»£c layer <code>RUN yarn install</code>, lÃ  layer Ã­t khi thay Ä‘á»•i. CÃ²n 1 quÃ¡ trÃ¬nh ná»¯a ráº¥t tá»‘n thá»i gian mÃ  gáº§n nhÆ° khÃ´ng thá»ƒ cache Ä‘Æ°á»£c báº±ng docker image layer lÃ  quÃ¡ trÃ¬nh build á»©ng dá»¥ng <code>RUN yarn build</code>. QuÃ¡ trÃ¬nh nÃ y Ä‘áº·c biá»‡t lÃ¢u Ä‘á»‘i vá»›i cÃ¡c project frontend kiá»ƒu react, vue hay angular. á» bÆ°á»›c nÃ y thÃ¬ code cá»§a chÃºng ta Ä‘Ã£ thay Ä‘á»•i, do Ä‘Ã³ docker layer cache Ä‘Ã£ bá»‹ vÃ´ hiá»‡u. Váº­y cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ giáº£m thá»i gian thÃªm vá»›i bÆ°á»›c nÃ y khÃ´ng?</p>
<blockquote>
<p><strong>Cáº¢NH BÃO:</strong> Viá»‡c tÃ¬m cÃ¡ch cache láº¡i step build Ä‘Ã²i há»i pháº£i hiá»ƒu rÃµ vá» framework / ngÃ´n ngá»¯ Ä‘ang lÃ m. Viá»‡c cache bá»«a cÃ³ thá»ƒ dáº«n Ä‘áº¿n xuáº¥t hiá»‡n rÃ¡c hoáº·c lá»—i phiÃªn báº£n sau khi build.</p>
</blockquote>
<p>Váº¥n Ä‘á» Ä‘ang gáº·p pháº£i:</p>
<ul>
<li><strong>Cáº§n giáº£m thá»i gian build app</strong></li>
<li>Code Ä‘Ã£ change ~&gt; <strong>khÃ´ng thá»ƒ cache báº±ng image layer cache</strong></li>
<li>CÃ³ thá»ƒ tá»‘i Æ°u build cache Ä‘Æ°á»£c náº¿u framework há»— trá»£. VÃ­ dá»¥: <a href="https://nextjs.org/docs/pages/building-your-application/deploying/ci-build-caching">NextJS build cache https://nextjs.org/docs/pages/building-your-application/deploying/ci-build-caching</a>, <a href="https://dev.to/manthanank/configuring-build-cache-in-angular-app-546p">Angular build cache https://dev.to/manthanank/configuring-build-cache-in-angular-app-546p</a></li>
</ul>
<p>~&gt; Idea lÃ  <strong>save Ä‘Æ°á»£c cÃ¡i path cache</strong> tÆ°Æ¡ng á»©ng vá»›i tá»«ng framework Ä‘Ã³ Ä‘á»ƒ dÃ¹ng <strong>giá»¯a cÃ¡c láº§n build</strong>.</p>
<p>~&gt; <strong>TÃ¬m cÃ¡ch lÆ°u giá»¯ láº¡i cÃ¡i path cache Ä‘Ã³ giá»¯a cÃ¡c láº§n build</strong>.</p>
<p>Ok, Ã½ tÆ°á»Ÿng Ä‘Ã£ cÃ³, giá» báº¯t tay vÃ´ lÃ m.</p>
<p>Máº·c dÃ¹ Ã½ tÆ°á»Ÿng nghe thÃ¬ ráº¥t Ä‘Æ¡n giáº£n, tÃ¬m cÃ¡ch save láº¡i cÃ¡i path cache Ä‘Ã³ giá»¯a cÃ¡c láº§n build lÃ  xong thÃ´i. Tuy nhiÃªn 1 rÃ o cáº£n ráº¥t lá»›n chÃ­nh lÃ  cÃ¡i path cache Ä‘Ã³ láº¡i tá»“n táº¡i trong docker image chá»© khÃ´ng pháº£i nÆ¡i gitlab runner cháº¡y script Ä‘á»ƒ cÃ³ thá»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng cache cá»§a gitlab CI.</p>
<p>á»¨ng dá»¥ng cá»§a táº¡i háº¡ lÃ  NextJS, do Ä‘Ã³ path cache cá»§a nÃ³ sáº½ lÃ  <code>.next/cache</code>. Giá» ta sáº½ tÃ¬m cÃ¡ch lÆ°u láº¡i cÃ¡i path nÃ y</p>
<p>Nhá»¯ng cÃ¡ch táº¡i háº¡ Ä‘Ã£ thá»­ (vÃ  fail lÃ²i):</p>
<ul>
<li>Thá»­ <strong>bind mount</strong> cá»§a docker buildkit khi <strong>build image</strong>. Tá»©c lÃ  mount 1 folder tá»« bÃªn ngoÃ i vÃ o quÃ¡ trÃ¬nh build image nhÆ° <a href="https://docs.docker.com/build/guide/mounts/#add-bind-mounts">https://docs.docker.com/build/guide/mounts/#add-bind-mounts</a>. Ta mount cÃ¡i <code>.next/cache</code> ra ngoÃ i host vÃ  <strong>hy vá»ng</strong> quÃ¡ trÃ¬nh sau quÃ¡ trÃ¬nh build cá»§a docker sáº½ ghi file ra ngoÃ i host. NhÆ°ng nÃ³ khÃ´ng hoáº¡t Ä‘á»™ng nhÆ° váº­y. <strong>Nhá»¯ng thay Ä‘á»•i trong cÃ¡i thÆ° má»¥c bind mount trong quÃ¡ trÃ¬nh build sáº½ KHÃ”NG ÄÆ¯á»¢C PHáº¢N ÃNH á» NGOÃ€I HOST</strong></li>
<li>Thá»­ <strong>cache mount</strong> cá»§a docker buildkit khi <strong>build image</strong>. Oh, nÃ³ sáº½ lÆ°u giá»¯ Ä‘Æ°á»£c <code>.next/cache</code> giá»¯ cÃ¡c láº§n build. NhÆ°ng viá»‡c cache nÃ y Ä‘Æ°á»£c tháº±ng buildkit nÃ³ lÆ°u vÃ  chá»‰ work vá»›i trÆ°á»ng há»£p mount docker sock nhÆ° táº¡i háº¡ Ä‘ang lÃ m, mÃ  cÅ©ng chá»‰ work trÃªn cÃ¹ng 1 host build chá»© Ä‘á»•i host khÃ¡c lÃ  tÃ¨o ~&gt; Bá».</li>
<li>Cháº¡y tháº±ng builder thÃ nh container, mount host volume Ä‘á»ƒ copy thÆ° má»¥c <code>.next/cache</code> ra host folder vÃ  dÃ¹ng gitlab ci cache Ä‘á»ƒ lÆ°u láº¡i. Tuy nhiÃªn sau Ä‘Ã³ táº¡i háº¡ nhanh chÃ³ng nháº­n ra vá»›i viá»‡c mount docker sock thÃ¬ container Ä‘ang cháº¡y script vÃ  container má»›i táº¡o Ä‘Ã³ lÃ  <strong>anh em</strong> (chá»© khÃ´ng pháº£i <strong>cha con</strong> nhÆ° docker-in-docker). Tá»©c lÃ  tháº±ng container builder kia nÃ³ mount ra <strong>host</strong> thÃ¬ mÃ¬nh Ä‘ang Ä‘á»©ng trong container cháº¡y job cÅ©ng khÃ´ng Ä‘á»c Ä‘Æ°á»£c ~&gt; Bá».</li>
</ul>
<p>Giá»¯a lÃºc tÆ°á»Ÿng chá»«ng má»i thá»© báº¿ táº¯c, thÃ¬ táº¡i háº¡ Ä‘á»™t nhiÃªn nháº­n ra 1 sá»± tháº­t:</p>
<ul>
<li>CÃ¡i thÆ° má»¥c <code>.next/cache</code> mÃ  ta Ä‘ang muá»‘n cache, thá»±c cháº¥t nÃ³ váº«n <strong>á»Ÿ trong cÃ¡i $IMAGE_TAG_BUILDER</strong> mÃ  táº¡i háº¡ pull tá»« lÃºc Ä‘áº§u Ä‘á»ƒ lÃ m cache docker layer.</li>
<li>Docker layer khÃ´ng thá»ƒ cache Ä‘Æ°á»£c chá»— Ä‘Ã³ vÃ¬ dÃ­nh <code>COPY . .</code>, nhÆ°ng cÃ¡i mÃ  táº¡i háº¡ cáº§n giá»¯ giá»¯a 2 láº§n build lÃ  cÃ¡i thÆ° má»¥c <code>.next/cache</code></li>
</ul>
<p>~&gt; <strong>Copy nÃ³ tá»« image cÅ© ra trÆ°á»›c khi build lÃ  Ä‘Æ°á»£c!!!</strong></p>
<p>Váº­y lÃ  sá»­a láº¡i 1 chÃºt cÃ¡i <code>.gitlab-ci.yml</code> Ä‘á»ƒ nÃ³ copy folder <code>.next/cache</code> tá»« image cÅ© ra trÆ°á»›c khi build.</p>
<pre><code class="language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">docker:24.0.7</span>

<span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">IMAGE_TAG_BUILDER:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE/builder:latest</span>
  <span class="hljs-attr">IMAGE_TAG:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span>
  <span class="hljs-attr">DOCKER_BUILDKIT:</span> <span class="hljs-string">&#x27;1&#x27;</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">gitlab-ci-token</span> <span class="hljs-string">-p</span> <span class="hljs-string">$CI_JOB_TOKEN</span> <span class="hljs-string">registry.gitlab.com</span>
    <span class="hljs-comment"># Make .next directory</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">.next</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">||</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Old image not exists, build from scratch&quot;</span>
    <span class="hljs-comment"># Copy cache folder from image </span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">image</span> <span class="hljs-string">inspect</span> <span class="hljs-string">&quot;$IMAGE_TAG_BUILDER&quot;</span> <span class="hljs-string">&amp;&gt;</span> <span class="hljs-string">/dev/null</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">container_id=$(docker</span> <span class="hljs-string">create</span> <span class="hljs-string">&quot;$IMAGE_TAG_BUILDER&quot;</span><span class="hljs-string">)</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">docker</span> <span class="hljs-string">cp</span> <span class="hljs-string">&quot;$container_id:/app/.next/cache&quot;</span> <span class="hljs-string">.next/</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">docker</span> <span class="hljs-string">rm</span> <span class="hljs-string">&quot;$container_id&quot;</span> <span class="hljs-string">||</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Image $IMAGE_TAG_BUILDER does not exist. Doing nothing.&quot;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--build-arg</span> <span class="hljs-string">BUILDKIT_INLINE_CACHE=1</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">--target=builder</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--build-arg</span> <span class="hljs-string">BUILDKIT_INLINE_CACHE=1</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span> <span class="hljs-string">-t</span> <span class="hljs-string">$IMAGE_TAG</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$IMAGE_TAG_BUILDER</span>
</code></pre>
<blockquote>
<p><strong>Tips:</strong> Báº¡n khÃ´ng cáº§n pháº£i run 1 container Ä‘á»ƒ copy file bÃªn trong ra mÃ  chá»‰ cáº§n <strong>create container</strong> lÃ  Ä‘á»§.</p>
</blockquote>
<p>Chá»— nÃ y Ä‘á»ƒ cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng Ä‘Æ°á»£c thÃ¬ pháº£i thÃªm dÃ²ng sau vÃ o <code>.dockerignore</code> Ä‘á»ƒ nÃ³ ignore thÆ° má»¥c <code>.next</code> nhÆ°ng bá» qua thÆ° má»¥c <code>.next/cache</code> thÃ¬ má»›i cÃ³ thá»ƒ copy Ä‘Æ°á»£c thÆ° má»¥c <code>.next/cache</code> vÃ o build context nhÃ©:</p>
<pre><code class="language-bash"><span class="hljs-comment"># other content</span>

.next
!.next/cache
</code></pre>
<p>Xong, hÃ£y kiá»ƒm tra thÃ nh quáº£ khi chá»‰ Ä‘á»•i code 1 chÃºt vÃ  build láº¡i:</p>
<p><img src="img/day-302/image-9.webp" alt="image.png"></p>
<p>Xem láº¡i pháº§n detail job, cÃ¡c báº¡n sáº½ tháº¥y lá»‡nh <code>yarn build</code> dÃ¹ khÃ´ng Ä‘Æ°á»£c docker layer cache nhÆ°ng cháº¡y vá»›i thá»i gian chá»‰ 13s thay vÃ¬ 38s nhÆ° nhá»¯ng láº§n build trÆ°á»›c Ä‘Ã³.</p>
<h2 id="ngoÃ i-lá»-Ä‘áº·t-tÃªn-docker-image-tá»‘i-Æ°u-cho-cicd">NgoÃ i lá»: Äáº·t tÃªn docker image tá»‘i Æ°u cho CI/CD</h2>
<p>Äáº·t tÃªn luÃ´n lÃ  má»™t váº¥n Ä‘á» khÃ³, tá»« bÃªn biáº¿n tá»›i tÃªn hÃ m vÃ  giá» lÃ  tÃªn image. LÃ m sao Ä‘á»ƒ nÃ³ Ä‘Ã¡p á»©ng Ä‘Æ°á»£c ráº¥t nhiá»u nhu cáº§u (mÃ  thÆ°á»ng lÃºc Ä‘áº·t tÃªn chÃºng ta khÃ´ng nghÄ© tá»›i)? Chá»‰ cÃ³ thá»ƒ xuáº¥t phÃ¡t tá»« tráº£i nghiá»‡m vÃ  kinh nghiá»‡m mÃ  thÃ´i. Äáº¿n 1 lÃºc nÃ o Ä‘Ã³, báº¡n gáº·p má»™t nhu cáº§u mÃ  cÃ¡i tÃªn cÅ© khÃ´ng Ä‘Ã¡p á»©ng Ä‘Æ°á»£c, thÃ¬ báº¡n sáº½ cÃ³ kinh nghiá»‡m cho láº§n sau.</p>
<p>CÃ²n Ä‘Ã¢y lÃ  má»™t sá»‘ kinh nghiá»‡m tá»« viá»‡c Ä‘áº·t tÃªn image cá»§a táº¡i háº¡. CÃ³ thá»ƒ nhá»¯ng cÃ¡i tÃªn nÃ y chá»‰ Ä‘Ã¡p á»©ng vá»›i nhu cáº§u nháº¥t Ä‘á»‹nh vÃ  khÃ´ng fit vá»›i nhu cáº§u cá»§a cÃ¡c báº¡n. NhÆ°ng hÃ£y láº¥y nhá»¯ng nhu cáº§u nÃ y Ä‘á»ƒ tham kháº£o xem mÃ¬nh cÃ³ táº­n dá»¥ng Ä‘Æ°á»£c gÃ¬ khÃ´ng nhÃ©.</p>
<p>Requirement:</p>
<ul>
<li>Má»—i láº§n build code pháº£i sinh ra 1 tag riÃªng tÆ°Æ¡ng á»©ng, tá»« image tag cÅ©ng tra cá»©u láº¡i Ä‘Æ°á»£c git history.</li>
<li>Image tag dá»… dÃ ng thay tháº¿ Ä‘Æ°á»£c trong cÃ¡c file manifest GitOps báº±ng cÃ¡c tool CLI</li>
<li>Giá»¯ láº¡i lá»‹ch sá»­ 5 tag gáº§n nháº¥t Ä‘á»ƒ rollback</li>
<li>TÃ¡ch biá»‡t mÃ´i trÆ°á»ng (dev, stg, prod) vá»›i 5 tag lá»‹ch sá»­ tÆ°Æ¡ng á»©ng</li>
<li>LÆ°u trá»¯ cáº£ cÃ¡c image trung gian (vÃ­ dá»¥ builder stage) Ä‘á»ƒ lÃ m cache</li>
</ul>
<p>Tá»« nhá»¯ng yÃªu cáº§u trÃªn, Ä‘Ã¢y lÃ  cÃ¡ch táº¡i háº¡ Ä‘áº·t tÃªn cho image:</p>
<pre><code class="language-yaml"><span class="hljs-attr">image:</span> <span class="hljs-string">docker:24.0.7</span>

<span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>

<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">RUNTIME_IMAGE_TAG:</span> <span class="hljs-string">runtime-$CI_COMMIT_SHORT_SHA</span>
  <span class="hljs-attr">RUNTIME_IMAGE:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:runtime-$CI_COMMIT_SHORT_SHA</span>
  <span class="hljs-attr">BUILDER_IMAGE:</span> <span class="hljs-string">$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME/builder:latest</span>
</code></pre>
<ul>
<li>á» Ä‘Ã¢y táº¡i háº¡ sá»­ dá»¥ng <code>runtime-$CI_COMMIT_SHORT_SHA</code> Ä‘á»ƒ Ä‘Ã¡nh tag cho runtime image. Sá»­ dá»¥ng <code>$CI_COMMIT_SHORT_SHA</code> thay cho <code>$CI_COMMIT_SHA</code> Ä‘á»ƒ image tag ngáº¯n hÆ¡n mÃ  váº«n Ä‘Ã¡p á»©ng Ä‘Æ°á»£c tÃ­nh unique. ThÃªm <code>runtime-</code> prefix Ä‘á»ƒ dá»… dÃ ng tÃ¬m ra cÃ¡i tag nÃ y hÆ¡n báº±ng cÃ¡c tool cli nhÆ° <code>sed</code> khi edit manifest trong GitOps.</li>
<li>ThÃªm <code>$CI_COMMIT_REF_NAME</code> vÃ o tÃªn image lÃ  Ä‘á»ƒ tÃ¡ch biá»‡t image giá»¯a cÃ¡c mÃ´i trÆ°á»ng (báº±ng branch) khÃ¡c nhau. Do Ä‘Ã³ cÃ³ thá»ƒ set Ä‘Æ°á»£c cleanup policy 5 tag gáº§n nháº¥t. Náº¿u khÃ´ng cÃ³ yáº¿u tá»‘ nÃ y mÃ  chá»‰ cÃ³ <code>$CI_REGISTRY_IMAGE:runtime-$CI_COMMIT_SHORT_SHA</code> thÃ¬ sáº½ khÃ´ng thá»ƒ clean Ä‘Æ°á»£c khi image á»Ÿ cÃ¡c mÃ´i trÆ°á»ng láº«n vÃ o nhau vÃ  nhiá»u khi clean image cÅ© sáº½ khiáº¿n mÃ´i trÆ°á»ng Ä‘ang cháº¡y bá»‹ lá»—i.</li>
<li>Äáº·t tÃªn builder image vá»›i <code>/builder</code> vÃ  tag <code>latest</code> vÃ¬ image builder chá»‰ cáº§n 1 image lÃ m cache vÃ  pháº£i tÃ¡ch báº¡ch pháº§n tÃªn vá»›i runtime image. Äá»«ng Ä‘áº·t tÃªn builder image kiá»ƒu <code>$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:builder</code> vÃ¬ nÃ³ cÅ©ng bá»‹ láº«n vá»›i image runtime vÃ  cleanup cÅ©ng pháº£i set rule Ä‘áº·c biá»‡t Ä‘Ã³.</li>
</ul>
<p>Sau Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ setup cleanup rule nhÆ° sau Ä‘á»ƒ Gitlab tá»± Ä‘á»™ng xÃ³a bá»›t image cÅ© khÃ´ng xÃ i tá»›i (vÃ  lÃ m náº·ng repo lÃªn ráº¥t ráº¥t nhiá»u)</p>
<p><img src="img/day-302/image-10.webp" alt="image.png"></p>
<h2 id="tá»•ng-káº¿t">Tá»•ng káº¿t</h2>
<p>TÃ³m táº¯t bÃ­ kÃ­p báº±ng 3 chiÃªu thá»©c chÃ­nh:</p>
<ul>
<li><strong>Setup self-hosted Gitlab runner Ä‘á»ƒ build Ä‘Æ°á»£c docker image</strong></li>
<li><strong>Sá»­ dá»¥ng docker layer cache Ä‘á»ƒ tá»‘i Æ°u cÃ¡c step install dependencies</strong></li>
<li><strong>TrÃ­ch xuáº¥t cache folder tá»« image cÅ© Ä‘á»ƒ tá»‘i Æ°u cÃ¡c step build code</strong></li>
</ul>
<p>Bonus thÃªm cho cÃ¡c vá»‹ huynh Ä‘Ã i chiÃªu thá»©c phá»¥: <strong>Äáº·t tÃªn docker image Ä‘á»ƒ phÃ¹ há»£p vá»›i quÃ¡ trÃ¬nh CI/CD</strong></p>
<p>Project Ä‘Æ°á»£c láº¥y lÃ m vÃ­ dá»¥ trong bÃ i Ä‘á»ƒ anh em tham kháº£o quÃ¡ trÃ¬nh CI/CD: <a href="https://gitlab.com/minhpq331/next-ecommerce/-/pipelines">https://gitlab.com/minhpq331/next-ecommerce/-/pipelines</a></p>
<p>Háº¿t rá»“i. Upvote cho sá»± tÃ¡i xuáº¥t giang há»“ nÃ y cá»§a táº¡i háº¡ nhÃ©.</p>
 
    </body>
</html>
